<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.MaterialRequireMapper" >
    <resultMap id="MaterialRequireMapperRM" type="MaterialRequire" autoMapping="true">
        <result property="materialRequireId" column="materialRequireId" javaType="String"></result>
        <result property="currentInventory" column="currentInventory" javaType="float"></result>
        <result property="marketPurchases" column="marketPurchases" javaType="float"></result>
        <result property="compatibilityId" column="compatibilityId" javaType="String"></result>
        <result property="remarks" column="remarks" javaType="String"></result>
        <result property="handleCategory" column="handleCategory" javaType="HandleCategory"></result>
        <result property="id" column="id"></result>
        <collection property="wastesList" select="getWastes" column="materialRequireId" ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>
    <resultMap id="MaterialRequireMapperRM1" type="MaterialRequire" autoMapping="true">
        <result property="id" column="id"></result>
        <collection property="wastesList" select="getWastes1" column="id" ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>
    <resultMap id="WastesRM" type="Wastes" autoMapping="true">
        <id property="id" column="id"></id>
        <result property="id1" column="id1"></result>
        <collection property="parameterList" select="getParameterList" column="id1"
                    ofType="com.jdlink.domain.Produce.Parameter" javaType="ArrayList"/>
    </resultMap>
    <select id="getWastes" resultMap="WastesRM" parameterType="String">
        SELECT * FROM t_wastes WHERE materialRequireId=#{materialRequireId}  order by nowTime desc;
    </select>
    <select id="getWastes1" resultMap="WastesRM" parameterType="String">
        SELECT * FROM t_wastes WHERE id1=#{id}  order by nowTime desc;
    </select>
    <select id="getParameterList" parameterType="String" resultType="MixingElement">
     select * from t_mixingelement where  id1=#{wastes.id1} order by nowTime desc ;
    </select>
    <select id="total" resultType="int">
    select count(*) from t_pr_materialrequire;
</select>
    <insert id="addMix" parameterType="MaterialRequire">
    insert into t_pr_materialrequire(materialRequireId,id,currentInventoryTotal,marketPurchasesTotal,remarks,compatibilityId,nowTime,safetyTotal,weeklyDemandTotal,formType,handleCategory,packageType,checkState)
    values (#{materialRequireId},#{id},#{currentInventory},#{marketPurchases},#{remarks},#{compatibilityId},NOW(),#{safety},#{weeklyDemand},#{formType},#{handleCategory},#{packageType},'ToSubmit');
<if test="wastesList.size()>0" >
<foreach collection="wastesList" item="wastes" index="index">
    insert into t_wastes (id,materialRequireId,id1) values (#{wastes.id},#{materialRequireId},#{id});
    <if test="wastes.parameterList.size()>0" >
        <foreach collection="wastes.parameterList" index="index" item="parameter">
            insert  into t_mixingelement(id,wastesId,minimum,maximum,parameter,materialRequireId,id1)
            values (#{parameter.id},#{wastes.id},#{parameter.minimum},#{parameter.maximum},#{parameter.parameter},#{materialRequireId},#{id});
        </foreach>
    </if>
</foreach>
</if>
</insert>
    <!--查找编号-->
    <select id="check" resultType="String">
        select materialRequireId from  t_pr_materialrequire order by nowTime desc ;
    </select>

    <select id="list" resultMap="MaterialRequireMapperRM" parameterType="String">
   select * from t_pr_materialrequire where materialRequireId=#{materialRequireId}  order by nowTime desc ;
    </select>
    <select id="getByMrId" resultMap="MaterialRequireMapperRM1" parameterType="String">
        select * from t_pr_materialrequire where id=#{id};
    </select>
    <update id="approval" >
        update t_pr_materialrequire set checkState='Approval',remarks=#{1},nowTime=NOW() where id=#{0};
    </update>
    <update id="submit" parameterType="String">
        update t_pr_materialrequire set checkState='ToExamine',nowTime=NOW() where id=#{id};
    </update>
    <update id="cancel" parameterType="String">
        update t_pr_materialrequire set checkState='Invalid',nowTime=NOW() where id=#{id};
    </update>
    <update id="back" parameterType="String">
        update t_pr_materialrequire set checkState='Backed',remarks=#{1},nowTime=NOW() where id=#{0};
    </update>
    <update id="updatemarketPurchases" >
        update  t_pr_materialrequire set marketPurchasesTotal=#{1} where
        id=#{0};
    </update>
    
    <resultMap id="MaterialList" type="MaterialRequire">
        <result property="materialRequireId" column="materialRequireId"></result>
        <collection property="materialRequireItemList" column="materialRequireId" select="getMaterialRequireItem"></collection>
    </resultMap>
    <select id="getMaterialRequireItem" resultType="MaterialRequireItem" parameterType="String">
        select * from t_pr_materialrequireitem where materialRequireId=#{materialRequireId}
    </select>
    <!--获取物料信息-->
    <select id="getMaterialList" resultMap="MaterialList">
        select  * from t_pr_materialrequire  order  by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>
    <!--通过编号获取物料信息-->
    <select id="getMaterialRequireById" parameterType="String" resultType="MaterialRequireItem">
           select  * from t_pr_materialrequireitem  where materialRequireId=#{materialRequireId};
    </select>


    <!--更新物料明细信息-->
    <update id="updateMaterialRequireItem" parameterType="MaterialRequireItem">
        update t_pr_materialrequireitem set  handleCategory=#{handleCategory},formType=#{formType},
        packageType=#{packageType},weeklyDemand=#{weeklyDemand},currentInventory=#{currentInventory},
        safety=#{safety},marketPurchases=#{marketPurchases} where id=#{id};
    </update>
    <!--更新主表信息-->
    <update id="updateMaterialRequire" parameterType="MaterialRequire">
        update t_pr_materialrequire set weeklyDemandTotal=#{weeklyDemandTotal},
        currentInventoryTotal=#{currentInventoryTotal},safetyTotal=#{safetyTotal},
        marketPurchasesTotal=#{marketPurchasesTotal},nowTime=NOW() where  materialRequireId=#{materialRequireId}
    </update>
    </mapper>