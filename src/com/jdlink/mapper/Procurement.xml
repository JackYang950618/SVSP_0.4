<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.ProcurementMapper" >
   <!--添加采购-->
    <insert id="add" parameterType="Procurement">
        insert into t_pl_procurement(receiptNumber, applyMouth, demandTime, applyDepartment, proposer, divisionHead, purchasingDirector, generalManager, id1, procurementCategory,nowTIme,purchasingHead,applyDate,suppliesCategory,state,createDate)
      values (#{receiptNumber},#{applyMouth},#{demandTime},#{applyDepartment},#{proposer},#{divisionHead},#{purchasingDirector},#{generalManager},#{id1},#{procurementCategory},NOW(),#{purchasingHead},#{applyDate},#{suppliesCategory},'Enabled',NOW());
    </insert>
    <!--寻找最新的采购主键-->
    <select id="getNewestId" resultType="String">
        select receiptNumber from t_pl_procurement order  by receiptNumber desc;
    </select>
    <!--添加物料表-->
    <insert id="addMaterial" parameterType="Material">
        insert into t_pl_material (suppliesName, specifications, inventory, note, purchaseQuantity, demandQuantity, receiptNumber,unit)
        values (#{suppliesName},#{specifications},#{inventory},#{note},#{purchaseQuantity},#{demandQuantity},#{receiptNumber},#{unit});
    </insert>
    <!--加载采购列表-->
    <resultMap id="ProcurementRM" type="Procurement" autoMapping="true">
        <result property="receiptNumber" column="receiptNumber" javaType="String"></result>
        <collection property="materialList" column="receiptNumber" select="getMaterial" ofType="Material"></collection>
    </resultMap>
    <!--获取所有的物料信息-->
    <select id="getMaterial" resultType="Material">
        select * from t_pl_material where receiptNumber=#{receiptNumber};
    </select>
    <!--获取月季采购-->
    <select id="getProcurementList" resultMap="ProcurementRM">
        select * from t_pl_procurement where procurementCategory='1'order by nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>
    <!--获取应急采购-->
    <select id="getEmergencyProcurementList" resultMap="ProcurementRM">
        select * from t_pl_procurement   where procurementCategory='0'order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>
    <!--根据编号查询信息-->
    <select id="getProcurementListById" parameterType="String" resultMap="ProcurementRM">
        select * from t_pl_procurement where receiptNumber=#{receiptNumber} order by nowTime desc;

    </select>
    <!--高级查询-->
    <select id="searchProcurement" parameterType="Procurement" resultMap="ProcurementRM">
        select * from t_pl_procurement
        <where>
            <if test="keywords != null and keywords != ''">
                or receiptNumber like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y-%m-%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y-%c-%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y-%c-%e %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y%m%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y%c%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y%c%e %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y.%m.%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y.%c.%d %H:%i:%s') like "%"#{keywords}"%"
                or DATE_FORMAT(demandTime,'%Y.%c.%e %H:%i:%s') like "%"#{keywords}"%"
                or applyMouth like "%"#{keywords}"%"
                or applyDepartment like binary "%"#{keywords}"%"
                or proposer like binary "%"#{keywords}"%"
                or divisionHead like binary "%"#{keywords}"%"
                or purchasingHead like binary "%"#{keywords}"%"
                or purchasingDirector like binary "%"#{keywords}"%"
                or generalManager like binary "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(applyDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or suppliesCategory like binary "%"#{keywords}"%"
            </if>
            <if test="receiptNumber!=null and receiptNumber!=''">
                and receiptNumber like binary "%"#{receiptNumber}"%"
            </if>
            <if test="applyMouth!=null and applyMouth!=''">
                and applyMouth = #{applyMouth}
            </if>
            <if test="date !=null and date !=''">
                and DATE_FORMAT(demandTime,'%Y-%m-%d %H:%i:%s') like "%"#{date}"%"
                and DATE_FORMAT(demandTime,'%Y%m%d% %H:%i:%s') like "%"#{date}"%"
            </if>
            <if test="applyDepartment!=null and applyDepartment!=''">
                and applyDepartment like binary "%"#{applyDepartment}"%"
            </if>
            <if test="proposer!=null and proposer!=''">
                and proposer like binary "%"#{proposer}"%"
            </if>
            <if test="divisionHead!=null and divisionHead!=''">
                and divisionHead like binary "%"#{divisionHead}"%"
            </if>
            <if test="purchasingHead!=null and purchasingHead!=''">
                and purchasingHead like binary "%"#{purchasingHead}"%"
            </if>
            <if test="purchasingDirector!=null and purchasingDirector!=''">
                and purchasingDirector like binary "%"#{purchasingDirector}"%"
            </if>
            <if test="generalManager!=null and generalManager!=''">
                and generalManager like binary "%"#{generalManager}"%"
            </if>
            <if test="applyDate!=null and applyDate!=''">
                and DATE_FORMAT(demandTime,'%Y-%m-%d') like "%"#{applyDate}"%"
                and DATE_FORMAT(demandTime,'%Y%m%d%') like "%"#{applyDate}"%"
            </if>
            <if test="suppliesCategory!=null and suppliesCategory!=''">
                and suppliesCategory like binary "%"#{suppliesCategory}"%"
            </if>
        </where>
    </select>
<!--加载辅料列表-->
    <select id="getIngredientsList" resultType="String">
        select ingredientsName from t_pl_ingredientslist;
    </select>
    <!--作废-->
    <update id="setProcurementListCancel" parameterType="String">
        update t_pl_procurement set state='Invalid',nowTIme=NOW() where receiptNumber=#{receiptNumber};
    </update>
    <update id="setProcurementListSubmit" parameterType="String">
        update t_pl_procurement set state='Submitted',nowTIme=NOW() where receiptNumber=#{receiptNumber};
    </update>

    <!--获取月度采购总数-->
    <select id="totalMouth" resultType="int">
        select count(*) from  t_pl_procurement where procurementCategory='1';
    </select>
    <!--获取应急采购总数-->
    <select id="totalEmc" resultType="int">
        select count(*) from  t_pl_procurement where procurementCategory='';
    </select>
    <!--获得最早的月季采购创建时间-->
    <select id="getNewestMouth" resultType="Date">
        select createDate from t_pl_procurement where createDate is not null  and procurementCategory='1' order by createDate;
    </select>
    <!--获得最早的应急采购申请时间-->
    <select id="getNewestEm" resultType="Date">
        select applyDate from t_pl_procurement where applyDate is not null  and procurementCategory='0' order by applyDate;
    </select>
</mapper>