<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.WayBillMapper">
    <resultMap id="WayBillRM" type="WayBill" autoMapping="true">
        <id column="id" property="id"/>
        <association property="produceCompany" column="produceCompanyId" select="getProduceCompany"/>
        <collection property="wayBillItemList" select="getItems" column="id"
                    ofType="com.jdlink.domain.Produce.WayBillItem"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="WayBillItemRM" type="WayBillItem" autoMapping="true">
        <id property="itemId" column="itemId"/>
        <association property="wastes" column="wastesId" select="getWastes"/>
        <association property="receiveCompany" column="receiveCompanyId" select="getReceiveCompany"/>
        <association property="salesman" column="salesmanId" select="getSalesman"/>
    </resultMap>

    <select id="getItems" parameterType="String" resultMap="WayBillItemRM">
        select  * from t_pr_waybillitem where wayBillId = #{id};
    </select>
    <select id="getProduceCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{produceCompanyId};
    </select>

    <select id="getReceiveCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{receiveCompanyId};
    </select>

    <select id="getWastes" parameterType="String" resultType="Wastes">
        select * from t_wastes where id = #{wastesId};
    </select>

    <select id="getSalesman" parameterType="String" resultType="Salesman">
        select * from salesman where salesmanId = #{salesmanId};
    </select>

    <select id="count" resultType="int">
          select count(*) from t_pr_waybill;
     </select>

    <select id="countById" resultType="int">
        select count(*) from t_pr_waybill where id like "%"#{id}"%";
    </select>

    <select id="countItem" resultType="int">
        select count(*) from t_pr_waybillitem;
    </select>

    <select id="countWastes" resultType="int">
        select count(*) from t_wastes;
    </select>

    <select id="getById" parameterType="String" resultMap="WayBillRM">
          select * from t_pr_waybill where id = #{id};
     </select>

    <select id="getItemById" parameterType="String" resultMap="WayBillItemRM">
        select * from t_pr_waybillitem where itemId = #{id};
    </select>

    <select id="getSalesmanIdByName" parameterType="String" resultType="String">
        select salesmanId from salesman where name = #{name};
    </select>

    <select id="getClientIdByName" parameterType="String" resultType="String">
        select clientId from client where companyName = #{name};
    </select>

    <select id="getWastesIdByName" parameterType="String" resultType="String">
        select t_wastes.id from t_wastes where name = #{name};
    </select>

    <select id="getWastesById" parameterType="String" resultType="String">
        select t_wastes.id from t_wastes where id = #{id};
    </select>

    <select id="listPage" resultMap="WayBillRM">
        select * from t_pr_waybill order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="search" parameterType="WayBill" resultMap="WayBillRM">
        select * from t_pr_waybill
        <where>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="produceCompany != null and produceCompany !=''">
                and produceCompanyName like "%"#{produceCompany.companyName}"%"
            </if>
            <if test="total != null and total !=''">
                and total = #{total}
            </if>
            <if test="founder !=null and founder !=''">
                and founder like "%"#{founder}"%"
            </if>
            <if test="wayBillDate !=null and wayBillDate !=''">
                and wayBillDate like "%"#{wayBillDate}"%"
            </if>
            <if test="produceCompanyOperator != null and produceCompanyOperator != ''">
                and produceCompanyOperator like "%"#{produceCompanyOperator}"%"
            </if>
            <if test="state != null and state != ''">
                and t_pr_waybill.state like "%"#{state}"%"
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="searchCount" parameterType="WayBill" resultType="int">
        select count(*) from t_pr_waybill
        <where>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="produceCompany.companyName != null and produceCompany.companyName !=''">
                and produceCompanyName like "%"#{produceCompany.companyName}"%"
            </if>
            <if test="total != null and total !=''">
                and total = #{total}
            </if>
            <if test="founder !=null and founder !=''">
                and founder like "%"#{founder}"%"
            </if>
            <if test="wayBillDate !=null and wayBillDate !=''">
                and wayBillDate like "%"#{wayBillDate}"%"
            </if>
            <if test="produceCompanyOperator != null and produceCompanyOperator != ''">
                and produceCompanyOperator like "%"#{produceCompanyOperator}"%"
            </if>
            <if test="state != null and state != ''">
                and t_pr_waybill.state like "%"#{state}"%"
            </if>
        </where>
    </select>

    <update id="approval" parameterType="WayBill">
        update t_pr_waybill set state = 'Approval',advice = #{advice} where id = #{id}
    </update>

    <update id="reject" parameterType="WayBill">
        update t_pr_waybill set state = 'Backed',advice = #{advice} where id = #{id}
    </update>

    <update id="submit" parameterType="String">
        update t_pr_waybill set state = 'Examining' where id = #{id}
    </update>

    <update id="invalid" parameterType="String">
        update t_pr_waybill set state = 'Invalid' where id = #{id}
    </update>

    <insert id="addItem" parameterType="WayBill">
        <foreach collection="wayBillItemList" index="index" item="wayBillItem">
            insert into t_pr_waybillitem
            (itemId,wayBillId,receiveDate,receiveCompanyOperator,invoiceNumber,invoiceDate,salesmanId,receiveCompanyId,wastesId)
            values
            (#{wayBillItem.itemId},#{wayBillItem.wayBillId},#{wayBillItem.receiveDate},#{wayBillItem.receiveCompanyOperator},#{wayBillItem.invoiceNumber},#{wayBillItem.invoiceDate},#{wayBillItem.salesman.salesmanId},#{wayBillItem.receiveCompany.clientId},#{wayBillItem.wastes.id});

            insert into t_wastes (id,name,unitPriceTax,wastesTotal,wasteAmount,freight)
            values
            (#{wayBillItem.wastes.id},#{wayBillItem.wastes.name},#{wayBillItem.wastes.unitPriceTax},#{wayBillItem.wastes.wastesTotal},#{wayBillItem.wastes.wasteAmount},#{wayBillItem.wastes.freight});
        </foreach>
    </insert>

    <insert id="addWayBill" parameterType="WayBill">
        insert into t_pr_waybill
        (id,total,remarks,wayBillDate,produceCompanyId,nowTime,produceCompanyOperator,state,produceCompanyName,founder)
        values
        (#{id},#{total},#{remarks},NOW(),#{produceCompany.clientId},NOW(),#{produceCompanyOperator},'NewBuild',#{produceCompany.companyName},#{founder});
        <foreach collection="wayBillItemList" index="index" item="wayBillItem">
            insert into t_pr_waybillitem
            (itemId,wayBillId,receiveDate,receiveCompanyOperator,invoiceNumber,invoiceDate,salesmanId,receiveCompanyId,wastesId)
            values
            (#{wayBillItem.itemId},#{id},#{wayBillItem.receiveDate},#{wayBillItem.receiveCompanyOperator},#{wayBillItem.invoiceNumber},#{wayBillItem.invoiceDate},#{wayBillItem.salesman.salesmanId},#{wayBillItem.receiveCompany.clientId},#{wayBillItem.wastes.id});

        </foreach>
    </insert>

</mapper>