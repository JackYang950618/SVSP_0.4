<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.WayBillMapper">
    <resultMap id="WayBillRM" type="WayBill" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="wayBillItemList" select="getItems" column="id"
                    ofType="com.jdlink.domain.Produce.WayBillItem"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="WayBillItemRM" type="WayBillItem" autoMapping="true">
        <id property="itemId" column="itemId"/>
    </resultMap>

    <select id="getItems" parameterType="String" resultMap="WayBillItemRM">
        select  * from t_pr_waybillitem where wayBillId = #{id};
    </select>

    <select id="count" resultType="int">
          select count(*) from t_pr_waybill;
     </select>

    <select id="countById" resultType="int">
        select count(*) from t_pr_waybill where id like "%"#{id}"%";
    </select>

    <select id="countItem" resultType="int">
        select count(*) from t_pr_waybillitem;
    </select>

    <select id="countWastes" resultType="int">
        select count(*) from t_wastes;
    </select>

    <select id="getById" parameterType="String" resultMap="WayBillRM">
          select * from t_pr_waybill where id = #{id};
     </select>

    <select id="getItemById" parameterType="String" resultMap="WayBillItemRM">
        select * from t_pr_waybillitem where itemId = #{id};
    </select>

    <select id="getSalesmanIdByName" parameterType="String" resultType="String">
        select salesmanId from salesman where name = #{name};
    </select>

    <select id="getClientIdByName" parameterType="String" resultType="String">
        select clientId from client where companyName = #{name};
    </select>

    <select id="getWastesIdByName" parameterType="String" resultType="String">
        select t_wastes.id from t_wastes where name = #{name};
    </select>

    <select id="getWastesById" parameterType="String" resultType="Wastes">
        select * from t_wastes where id = #{id};
    </select>

    <select id="getByName" parameterType="String" resultMap="WayBillRM">
        select * from t_pr_waybill where produceCompanyName=#{produceCompanyName};
    </select>

    <select id="listPage" resultMap="WayBillRM">
        select * from t_pr_waybill order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="search" parameterType="WayBill" resultMap="WayBillRM">
        select * from t_pr_waybill
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or produceCompanyName like "%"#{keywords}"%"
                or total like "%"#{keywords}"%"
                or freight like "%"#{keywords}"%"
                or founder like "%"#{keywords}"%"
                or (DATE_FORMAT(wayBillDate,'%Y-%m-%d') like "%"#{keywords}"%" or DATE_FORMAT(wayBillDate,'%Y%m%d') like "%"#{keywords}"%")
                or remarks like "%"#{keywords}"%"
                or produceCompanyOperator like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="produceCompanyName != null and produceCompanyName !=''">
                and produceCompanyName like "%"#{produceCompanyName}"%"
            </if>
            <if test="total != null and total !=''">
                and total = #{total}
            </if>
            <if test="freight !=null and freight !='' ">
                and freight = #{freight}
            </if>
            <if test="founder !=null and founder !=''">
                and founder like "%"#{founder}"%"
            </if>
            <if test="remarks !=null and remarks !=''">
                and (DATE_FORMAT(wayBillDate,'%Y-%m-%d') like "%"#{remarks}"%"
                or DATE_FORMAT(wayBillDate,'%Y%m%d') like "%"#{remarks}"%")
            </if>
            <if test="produceCompanyOperator != null and produceCompanyOperator != ''">
                and produceCompanyOperator like "%"#{produceCompanyOperator}"%"
            </if>
            <if test="state != null and state != ''">
                and t_pr_waybill.state = #{state}
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="searchCount" parameterType="WayBill" resultType="int">
        select count(*) from t_pr_waybill
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or produceCompanyName like "%"#{keywords}"%"
                or total like "%"#{keywords}"%"
                or freight like "%"#{keywords}"%"
                or founder like "%"#{keywords}"%"
                or (DATE_FORMAT(wayBillDate,'%Y-%m-%d') like "%"#{keywords}"%" or DATE_FORMAT(wayBillDate,'%Y%m%d') like "%"#{keywords}"%")
                or remarks like "%"#{keywords}"%"
                or produceCompanyOperator like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="produceCompanyName != null and produceCompanyName !=''">
                and produceCompanyName like "%"#{produceCompanyName}"%"
            </if>
            <if test="total != null and total !=''">
                and total = #{total}
            </if>
            <if test="freight !=null and freight !='' ">
                and freight = #{freight}
            </if>
            <if test="founder !=null and founder !=''">
                and founder like "%"#{founder}"%"
            </if>
            <if test="remarks !=null and remarks !=''">
                and (DATE_FORMAT(wayBillDate,'%Y-%m-%d') like "%"#{remarks}"%"
                or DATE_FORMAT(wayBillDate,'%Y%m%d') like "%"#{remarks}"%")
            </if>
            <if test="produceCompanyOperator != null and produceCompanyOperator != ''">
                and produceCompanyOperator like "%"#{produceCompanyOperator}"%"
            </if>
            <if test="state != null and state != ''">
                and t_pr_waybill.state = #{state}
            </if>
        </where>
    </select>

    <select id="getWayBillItemByClientIdAndWastesCode" resultMap="WayBillItemRM">
        select * from t_pr_waybillitem
        where wayBillId in ( select id from t_pr_waybill where produceCompanyId=#{clientId})
        and wastesCode =#{code};
    </select>

    <update id="approval" parameterType="WayBill">
        update t_pr_waybill set state = 'Approval',advice = #{advice} where id = #{id}
    </update>

    <update id="reject" parameterType="WayBill">
        update t_pr_waybill set state = 'Backed',advice = #{advice} where id = #{id}
    </update>

    <update id="submit" parameterType="String">
        update t_pr_waybill set state = 'Examining' where id = #{id}
    </update>

    <update id="invalid" parameterType="String">
        update t_pr_waybill set state = 'Invalid' where id = #{id}
    </update>

    <update id="update" parameterType="WayBill">
        update t_pr_waybill
        set total=#{total},freight=#{freight},remarks=#{remarks},wayBillDate=NOW(),produceCompanyId=#{produceCompanyId},
        nowTime=NOW(),produceCompanyOperator=#{produceCompanyOperator},produceCompanyName=#{produceCompanyName},
        founder=#{founder}
        where id = #{id};
        <foreach collection="wayBillItemList" index="index" item="wayBillItem">
            update t_pr_waybillitem
            set itemId=#{wayBillItem.itemId},receiveDate=#{wayBillItem.receiveDate},
            receiveCompanyOperator=#{wayBillItem.receiveCompanyOperator},invoiceNumber=#{wayBillItem.invoiceNumber},
            invoiceDate=#{wayBillItem.invoiceDate},salesmanName=#{wayBillItem.salesmanName},
            receiveCompanyName=#{wayBillItem.receiveCompanyName},wastesId=#{wayBillItem.wastesId},
            wastesCode =#{wayBillItem.wastesCode},wastesAmount=#{wayBillItem.wastesAmount},wastesName=#{wayBillItem.wastesName},
            wastesPrice=#{wayBillItem.wastesPrice},wastesTotalPrice=#{wayBillItem.wastesTotalPrice}
            where wayBillId=#{id};
        </foreach>
    </update>

    <insert id="addItem" parameterType="WayBill">
    <foreach collection="wayBillItemList" index="index" item="wayBillItem">
        insert into t_pr_waybillitem
        (itemId,wayBillId,receiveDate,receiveCompanyOperator,invoiceNumber,invoiceDate,salesmanName,receiveCompanyName,wastesId,wastesCode,wastesPrice,wastesName,wastesAmount,wastesTotalPrice)
        values
        (#{wayBillItem.itemId},#{wayBillItem.wayBillId},#{wayBillItem.receiveDate},#{wayBillItem.receiveCompanyOperator},#{wayBillItem.invoiceNumber},#{wayBillItem.invoiceDate},#{wayBillItem.salesmanName},#{wayBillItem.receiveCompanyName},#{wayBillItem.wastesId},
        #{wayBillItem.wastesCode},#{wayBillItem.wastesPrice},#{wayBillItem.wastesName},#{wayBillItem.wastesAmount},#{wayBillItem.wastesTotalPrice});
    </foreach>
</insert>

    <insert id="addWayBill" parameterType="WayBill">
        insert into t_pr_waybill
        (id,total,freight,remarks,wayBillDate,produceCompanyId,nowTime,produceCompanyOperator,state,produceCompanyName,founder)
        values
        (#{id},#{total},#{freight},#{remarks},NOW(),#{produceCompanyId},NOW(),#{produceCompanyOperator},'NewBuild',#{produceCompanyName},#{founder});
        <foreach collection="wayBillItemList" index="index" item="wayBillItem">
            insert into t_pr_waybillitem
            (itemId,wayBillId,receiveDate,receiveCompanyOperator,invoiceNumber,invoiceDate,salesmanName,receiveCompanyName,wastesId,wastesCode,wastesPrice,wastesName,wastesAmount,wastesTotalPrice)
            values
            (#{wayBillItem.itemId},#{wayBillItem.wayBillId},#{wayBillItem.receiveDate},#{wayBillItem.receiveCompanyOperator},#{wayBillItem.invoiceNumber},#{wayBillItem.invoiceDate},#{wayBillItem.salesmanName},#{wayBillItem.receiveCompanyName},#{wayBillItem.wastesId},
            #{wayBillItem.wastesCode},#{wayBillItem.wastesPrice},#{wayBillItem.wastesName},#{wayBillItem.wastesAmount},#{wayBillItem.wastesTotalPrice});
        </foreach>
    </insert>

    <select id="getWayBillById" parameterType="String" resultMap="WayBillRM">
        select * from t_pr_waybill where id =#{id};
    </select>
</mapper>