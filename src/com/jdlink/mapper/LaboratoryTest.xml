<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.LaboratoryTestMapper" >
    <resultMap id="LaboratoryTestRM" type="LaboratoryTest" autoMapping="true">
        <id property="laboratoryTestNumber" column="laboratoryTestNumber"/>
        <association property="client" column="clientId" select="getClient"/>
        <collection property="wastesList" select="getWastesList" column="laboratoryTestNumber"
                    ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>
    <resultMap id="WastesRM" type="Wastes" autoMapping="true">
        <id property="id" column="id"/>
        <collection property="parameterList" select="getParameterList" column="id"
                    ofType="com.jdlink.domain.Produce.Parameter" javaType="ArrayList"/>
        <collection property="heavyMetalList" select="getHeavyMetalList" column="id"
                    ofType="com.jdlink.domain.Produce.HeavyMetal" javaType="ArrayList"/>
    </resultMap>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM t_pr_laboratorytest;
    </select>

    <insert id="add" parameterType="LaboratoryTest">
        INSERT INTO t_pr_laboratorytest (laboratorytestnumber, querynumber, clientId, companyName, record, recorddate,
        laboratory, laboratorycompany, laboratorydate, checkState, nowTime) VALUES (#{laboratoryTestNumber},
        #{queryNumber}, #{client.clientId}, #{client.companyName}, #{record}, #{recordDate}, #{laboratory}, #{laboratoryCompany},
        #{laboratoryDate}, #{checkState}, NOW());
        <if test="wastesList.size() > 0">
            <foreach collection="wastesList" item="wastes" index="index">
                INSERT INTO t_wastes (id, name, wastesId, isProductionLine, isStorageArea, samplingDate,
                samplingNumber, testDate, laboratoryTestNumber, clientId) VALUES (#{wastes.id}, #{wastes.name}, #{wastes.wastesId},
                #{wastes.isProductionLine}, #{wastes.isStorageArea}, #{wastes.samplingDate}, #{wastes.samplingNumber},
                #{wastes.testDate}, #{laboratoryTestNumber}, #{client.clientId});
                <if test="wastes.parameterList.size() > 0">
                    <foreach collection="wastes.parameterList" item="parameter" index="index">
                        INSERT INTO t_mixingelement (id, name, minimum, average, maximum, nowTime, parameter,
                        wastesId) VALUES (#{parameter.id}, #{parameter.name}, #{parameter.minimum}, #{parameter.average},
                        #{parameter.maximum}, NOW(), #{parameter.parameter}, #{wastes.id});
                    </foreach>
                </if>
                <if test="wastes.heavyMetalList.size() > 0">
                    <foreach collection="wastes.heavyMetalList" item="heavyMetal" index="index">
                        INSERT INTO t_mixingelement (id, name, minimum, average, maximum, nowTime, heavyMetal,
                        wastesId) VALUES (#{heavyMetal.id}, #{heavyMetal.name}, #{heavyMetal.minimum}, #{heavyMetal.average},
                        #{heavyMetal.maximum}, NOW(), #{heavyMetal.heavyMetal}, #{wastes.id});
                    </foreach>
                </if>
            </foreach>
        </if>
    </insert>

    <select id="list" resultMap="LaboratoryTestRM">
        SELECT * FROM t_pr_laboratorytest ORDER BY nowTime DESC
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="search" parameterType="LaboratoryTest" resultMap="LaboratoryTestRM">
        SELECT * FROM t_pr_laboratorytest
        <where>
            <if test="keyword != null and keyword != ''">
                and laboratoryTestNumber LIKE "%"#{keyword}"%" or queryNumber like "%"#{keyword}"%"
                or companyName like "%"#{keyword}"%" or record like "%"#{keyword}"%"
                or laboratoryDate like binary "%"#{keyword}"%" or laboratory like "%"#{keyword}"%"
                or laboratoryCompany like "%"#{keyword}"%"
            </if>
            <if test="laboratoryTestNumber != null and laboratoryTestNumber != ''">
                and laboratoryTestNumber LIKE "%"#{laboratoryTestNumber}"%"
            </if>
            <if test="queryNumber != null and queryNumber != ''">
                and queryNumber LIKE "%"#{queryNumber}"%"
            </if>
            <if test="client != null and client.companyName != null and client.companyName != ''">
                and companyName LIKE "%"#{client.companyName}"%"
            </if>
            <if test="record != null and record != ''">
                and record LIKE "%"#{record}"%"
            </if>
            <if test="laboratoryDate != null and laboratoryDate != ''">
                and laboratoryDate LIKE binary "%"#{laboratoryDate}"%"
            </if>
            <if test="laboratory != null and laboratory != ''">
                and laboratory LIKE "%"#{laboratory}"%"
            </if>
            <if test="laboratoryCompany != null and laboratoryCompany != ''">
                and laboratoryCompany LIKE "%"#{laboratoryCompany}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState = #{checkState}
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="searchCount" parameterType="LaboratoryTest" resultType="int">
        SELECT COUNT(*) FROM t_pr_laboratorytest
        <where>
            <if test="keyword != null and keyword != ''">
                and laboratoryTestNumber LIKE "%"#{keyword}"%" or queryNumber like "%"#{keyword}"%"
                or companyName like "%"#{keyword}"%" or record like "%"#{keyword}"%"
                or laboratoryDate like binary "%"#{keyword}"%" or laboratory like "%"#{keyword}"%"
                or laboratoryCompany like "%"#{keyword}"%"
            </if>
            <if test="laboratoryTestNumber != null and laboratoryTestNumber != ''">
                and laboratoryTestNumber LIKE "%"#{laboratoryTestNumber}"%"
            </if>
            <if test="queryNumber != null and queryNumber != ''">
                and queryNumber LIKE "%"#{queryNumber}"%"
            </if>
            <if test="client != null and client.companyName != null and client.companyName != ''">
                and companyName LIKE "%"#{client.companyName}"%"
            </if>
            <if test="record != null and record != ''">
                and record LIKE "%"#{record}"%"
            </if>
            <if test="laboratoryDate != null and laboratoryDate != ''">
                and laboratoryDate LIKE binary "%"#{laboratoryDate}"%"
            </if>
            <if test="laboratory != null and laboratory != ''">
                and laboratory LIKE "%"#{laboratory}"%"
            </if>
            <if test="laboratoryCompany != null and laboratoryCompany != ''">
                and laboratoryCompany LIKE "%"#{laboratoryCompany}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState = #{checkState}
            </if>
        </where>
    </select>

    <select id="getClient" resultType="Client">
        SELECT * FROM client WHERE clientId=#{clientId};
    </select>

    <select id="getLaboratoryTestById" parameterType="String" resultMap="LaboratoryTestRM">
        SELECT * FROM t_pr_laboratorytest WHERE laboratoryTestNumber= #{laboratoryTestNumber};
    </select>

    <select id="getWastesList" parameterType="String" resultMap="WastesRM">
        select * from t_wastes where laboratoryTestNumber=#{laboratoryTestNumber};
    </select>

    <update id="setInvalid" parameterType="String">
        update t_pr_laboratorytest set checkState = 'Invalid' where laboratoryTestNumber = #{laboratoryTestNumber};
    </update>

    <update id="setTested" parameterType="String">
        update t_pr_laboratorytest set checkState = 'Tested' where laboratoryTestNumber = #{laboratoryTestNumber};
    </update>

    <update id="submit" parameterType="String">
        update t_pr_laboratorytest set checkState = 'Submitted' where laboratoryTestNumber = #{laboratoryTestNumber};
    </update>

    <update id="confirm" parameterType="String">
        update t_pr_laboratorytest set checkState = 'Confirm' where laboratoryTestNumber = #{laboratoryTestNumber};
    </update>

    <select id="getParameterList" parameterType="String" resultType="MixingElement">
        select * from t_mixingelement where wastesId=#{id};
    </select>

    <select id="getHeavyMetalList" parameterType="String" resultType="MixingElement">
        select * from t_mixingelement where wastesId=#{id};
    </select>
</mapper>