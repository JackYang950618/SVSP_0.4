<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.TransportPlanMapper">
    <resultMap id="TransportPlanRM" type="TransportPlan" autoMapping="true">
        <id property="id" column="id"/>
        <result property="group" column="group"/>
        <collection property="transportPlanItemList" select="getTransportPlanItemList" column="id"
                    ofType="com.jdlink.domain.Produce.TransportPlanItem" javaType="ArrayList"/>
    </resultMap>
    <resultMap id="TransportPlanItemRM" type="TransportPlanItem" autoMapping="true">
        <id property="id" column="id"/>
        <association property="produceCompany" column="produceCompanyId" select="getProduceCompany"/>
        <association property="wastes" column="id" select="getWastes"/>
    </resultMap>
    <resultMap id="ClientRM" type="Client" autoMapping="true">
        <id property="clientId" column="clientId"/>
        <association property="salesman" column="salesmanId" select="getSalesman"/>
    </resultMap>
    <insert id="add" parameterType="TransportPlan">
        INSERT INTO t_pr_transportplan (id, author, departmentDirector, productionDirector, `group`, nowTime, checkState, createDate)
        VALUES (#{id}, #{author}, #{departmentDirector}, #{productionDirector}, #{group}, NOW(), #{checkState}, NOW());
        <if test="transportPlanItemList.size() > 0">
            <foreach collection="transportPlanItemList" item="transportPlanItem" index="index">
                INSERT INTO t_pr_transportplanitem (id, produceCompanyId, handleCategory,
                approachTime, wastesId, transportPlanId) VALUES (#{transportPlanItem.id},
                #{transportPlanItem.produceCompany.clientId}, #{transportPlanItem.handleCategory},
                #{transportPlanItem.approachTime}, #{transportPlanItem.wastes.id}, #{id});
                UPDATE t_wastes SET name=#{transportPlanItem.wastes.name}, formType=#{transportPlanItem.wastes.formType},
                wastesId=#{transportPlanItem.wastes.wastesId}, ph=#{transportPlanItem.wastes.ph}, ashPercentage=#{transportPlanItem.wastes.ashPercentage},
                wetPercentage=#{transportPlanItem.wastes.wetPercentage}, calorific=#{transportPlanItem.wastes.calorific},
                sulfurPercentage=#{transportPlanItem.wastes.sulfurPercentage}, fluorinePercentage=#{transportPlanItem.wastes.fluorinePercentage},
                phosphorusPercentage=#{transportPlanItem.wastes.phosphorusPercentage}, chlorinePercentage=#{transportPlanItem.wastes.chlorinePercentage},
                nowTime=NOW(), packageType=#{transportPlanItem.wastes.packageType}, wasteAmount=#{transportPlanItem.wastes.wasteAmount}, unit=#{transportPlanItem.wastes.unit},
                processWay=#{transportPlanItem.wastes.processWay}, transportPlanItemId=#{transportPlanItem.id} WHERE id=#{transportPlanItem.wastes.id};
            </foreach>
        </if>
    </insert>

    <update id="update" parameterType="TransportPlan">
        <if test="transportPlanItemList.size() > 0">
            <foreach collection="transportPlanItemList" item="transportPlanItem" index="index">
                UPDATE t_pr_transportplanitem SET approachTime=#{transportPlanItem.approachTime} WHERE t_pr_transportplanitem.id=#{transportPlanItem.id};

                UPDATE t_wastes SET wasteAmount=#{transportPlanItem.wastes.wasteAmount}, unit=#{transportPlanItem.wastes.unit},
                processWay=#{transportPlanItem.wastes.processWay} WHERE t_wastes.id=#{transportPlanItem.wastes.id};
            </foreach>
        </if>
    </update>

    <select id="getRecent" resultMap="TransportPlanRM">
        SELECT * FROM t_pr_transportplan WHERE checkState != 'Invalid' ORDER BY nowTime DESC LIMIT 1;
    </select>

    <select id="getById" parameterType="String" resultMap="TransportPlanRM">
        SELECT * FROM t_pr_transportplan WHERE id=#{id};
    </select>
    <select id="getTransportPlanItemList" parameterType="String" resultMap="TransportPlanItemRM">
        SELECT * FROM t_pr_transportplanitem WHERE transportPlanId=#{id};
    </select>

    <select id="getProduceCompany" parameterType="String" resultMap="ClientRM">
        SELECT * FROM client WHERE clientId=#{produceCompanyId};
    </select>

    <select id="getWastes" parameterType="String" resultType="Wastes">
        SELECT * FROM t_wastes WHERE transportPlanItemId=#{id};
    </select>
    <select id="getSalesman" parameterType="String" resultType="Salesman">
        select * from salesman where salesmanId = #{salesmanId};
    </select>

    <update id="setStateConfirm" parameterType="String">
        UPDATE t_pr_transportplan SET checkState='Confirm' WHERE id = #{id};
    </update>
    <update id="setStateSubmit" parameterType="String">
        UPDATE t_pr_transportplan SET checkState='Submitted' WHERE id = #{id};
    </update>
    <update id="setStateExamined" parameterType="String">
        UPDATE t_pr_transportplan SET checkState='Approval' WHERE id = #{id};
    </update>
    <update id="setStateInvalid" parameterType="String">
        UPDATE t_pr_transportplan SET checkState='Invalid' WHERE id = #{id};
    </update>

    <!--按页列出所有运输计划单-->
    <select id="list" resultMap="TransportPlanRM">
        SELECT * FROM t_pr_transportplan ORDER BY nowTime DESC
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <!--获取运输计划单的数量-->
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM t_pr_transportplan;
    </select>

    <!--搜索运输计划单-->
    <select id="search" parameterType="TransportPlan" resultMap="TransportPlanRM">
        SELECT * FROM t_pr_transportplan
        <where>
            <if test="keyword != null and keyword != ''">
                and id LIKE "%"#{keyword}"%"
                or author like "%"#{keyword}"%"
                or (DATE_FORMAT(createDate,'%Y-%m-%d') like "%"#{keyword}"%")
            </if>
            <if test="id != null and id != ''">
                and id LIKE "%"#{id}"%"
            </if>
            <if test="author != null and author != ''">
                and author like "%"#{author}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState = #{checkState}
            </if>
            <if test="departmentDirector != null and departmentDirector != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                <![CDATA[
                and (DATE_FORMAT(createDate,'%Y-%m-%d') >= #{departmentDirector})
                ]]>
            </if>
            <if test="productionDirector != null and productionDirector != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                <![CDATA[
                and (DATE_FORMAT(createDate,'%Y-%m-%d') <= #{productionDirector})
                ]]>
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--搜索运输计划单数量-->
    <select id="searchCount" parameterType="TransportPlan" resultType="int">
        SELECT count(*) FROM t_pr_transportplan
        <where>
            <if test="keyword != null and keyword != ''">
                and id LIKE "%"#{keyword}"%"
                or author like "%"#{keyword}"%"
                or (DATE_FORMAT(createDate,'%Y-%m-%d') like "%"#{keyword}"%")
            </if>
            <if test="id != null and id != ''">
                and id LIKE "%"#{id}"%"
            </if>
            <if test="author != null and author != ''">
                and author like "%"#{author}"%"
            </if>
            <if test="checkState != null and checkState != ''">
                and checkState = #{checkState}
            </if>
            <if test="departmentDirector != null and departmentDirector != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                <![CDATA[
                and (DATE_FORMAT(createDate,'%Y-%m-%d') >= #{departmentDirector})
                ]]>
            </if>
            <if test="productionDirector != null and productionDirector != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                <![CDATA[
                and (DATE_FORMAT(createDate,'%Y-%m-%d') <= #{productionDirector})
                ]]>
            </if>
        </where>
    </select>

</mapper>