<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.InboundMapper">
    <!--入库计划单映射集-->
    <resultMap id="InboundPlanOrderRM" type="InboundPlanOrder" autoMapping="true">
        <id column="inboundPlanOrderId" property="inboundPlanOrderId"/>
        <association property="wastes" javaType="com.jdlink.domain.Wastes">
            <result column="wastesName" property="name"/>
            <result column="wastesCode" property="wastesId"/>
            <result column="wastesCategory" property="category"/>
        </association>
        <association property="produceCompany" column="produceCompanyId" select="getProduceCompany"/>
        <association property="acceptCompany" column="acceptCompanyId" select="getAcceptCompany"/>
    </resultMap>

    <!--入库单映射集-->
    <resultMap id="InboundOrderRM" type="InboundOrder" autoMapping="true">
        <id column="inboundOrderId" property="inboundOrderId"/>
        <collection property="inboundOrderItemList" column="inboundOrderId" select="getInboundOrderItemList"
                    ofType="com.jdlink.domain.Produce.Parameter" javaType="ArrayList"/>
    </resultMap>

    <resultMap id="InboundOrderItemRM" type="InboundOrderItem" autoMapping="true">
        <id column="inboundOrderItemId" property="inboundOrderItemId"/>
        <association property="produceCompany" select="getProduceCompany" column="produceCompanyId"/>
        <association property="wastes" javaType="Wastes">
            <id property="name" column="wastesName"/>
            <result property="wastesId" column="wastesCode"/>
            <result property="category" column="wastesCategory"/>
        </association>
    </resultMap>

    <select id="listInboundPlanOrder" resultMap="InboundPlanOrderRM">
        SELECT * FROM t_pl_inboundplanorder;
    </select>

    <!-- 增加入库计划单 -->
    <insert id="addInboundPlanOrder" parameterType="InboundPlanOrder" >
        INSERT INTO t_pl_inboundplanorder (inboundPlanOrderId, planDate, produceCompanyId,
        acceptCompanyId, transferDate, transferDraftId, prepareTransferCount, transferCount, storageCount,
        leftCount, poundsCount, wastesName, wastesCode, wastesCategory, creatorId, createDate, departmentId, companyId,
        modifierId, salesmanId, checkState, recordState, processWay, handleCategory, isQualified)
        VALUES (#{inboundPlanOrderId}, #{planDate}, #{produceCompany.clientId},
        #{acceptCompany.clientId}, #{transferDate}, #{transferDraftId}, #{prepareTransferCount}, #{transferCount}, #{storageCount},
        #{leftCount}, #{poundsCount}, #{wastes.name}, #{wastes.code}, #{wastes.category}, #{creatorId}, #{createDate}, #{departmentId},
        #{companyId}, #{modifierId}, #{salesman.salesmanId}, #{checkState}, #{recordState}, #{processWay}, #{handleCategory},
        #{isQualified});
    </insert>

    <select id="searchInboundPlanOrder" parameterType="InboundPlanOrder" resultMap="InboundPlanOrderRM">
        SELECT * FROM t_pl_inboundplanorder
        <where>
            <if test="inboundPlanOrderId != null and inboundPlanOrderId != ''">
                and inboundPlanOrderId LIKE "%"#{inboundPlanOrderId}"%"
            </if>
            <if test="departmentId != null and departmentId != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                and (DATE_FORMAT(planDate,'%Y-%m-%d') like "%"#{departmentId}"%"
                or DATE_FORMAT(planDate,'%Y%m%d') like "%"#{departmentId}"%")
            </if>
            <if test="companyId != null and companyId != ''">
                <!--用searchDate来代装创建日期数据，防止被自动赋成日期格式的数据-->
                and (DATE_FORMAT(transferDate,'%Y-%m-%d') like "%"#{companyId}"%"
                or DATE_FORMAT(transferDate,'%Y%m%d') like "%"#{companyId}"%")
            </if>
            <if test="transferDraftId != null and transferDraftId != ''">
                and transferDraftId LIKE "%"#{transferDraftId}"%"
            </if>
            <if test="wastes != null">
                <if test="wastes.name != null and wastes.name != ''">
                    and wastesName LIKE "%"#{wastes.name}"%"
                </if>
                <if test="wastes.wastesId != null and wastes.wastesId != ''">
                    and wastesCode LIKE "%"#{wastes.wastesId}"%"
                </if>
            </if>
        </where>
    </select>

    <!-- 查询入库计划单中的前缀数量 -->
    <select id="getInboundPlanCountByPrefix" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM t_pl_inboundplanorder WHERE inboundPlanOrderId LIKE "%"#{prefix}"%";
    </select>

    <select id="getProduceCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{produceCompanyId};
    </select>
    <select id="getAcceptCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{acceptCompanyId};
    </select>

    <!--增加入库单-->
    <insert id="addInboundOrder" parameterType="InboundOrder">
        INSERT INTO t_pl_inboundorder (inboundOrderId, inboundDate, warehouseId, boundType, keeperId, directorId, approverId, checkState, remarks, creatorId, createDate, departmentId, companyId, modifierId,
        modifyDate, recordState, category) VALUES (#{inboundOrderId}, #{inboundDate}, #{wareHouse.warehouseId}, #{boundType},
        #{keeperId}, #{directorId}, #{approverId}, #{checkState}, #{remarks},
        #{creatorId}, #{createDate}, #{departmentId}, #{companyId}, #{modifierId}, #{modifyDate},
        #{recordState}, 0);
        <if test="inboundOrderItemList.size() > 0">
            <foreach collection="inboundOrderItemList" item="inboundOrderItem" index="index">
                INSERT INTO t_pl_inboundorderitem (inboundOrderItemId, transferDraftId, inboundOrderId,
                produceCompanyId, processWay, handleCategory,
                remarks, warehouseArea, recordState, isQualified, wastesName, wastesCode, wastesCategory, wastesAmount,
                unitPriceTax,
                totalPrice, laboratoryTestId, category) VALUES (#{inboundOrderItem.inboundOrderItemId}, #{inboundOrderItem.transferDraftId},
                #{inboundOrderItem.inboundOrderId},
                #{inboundOrderItem.produceCompany.clientId}, #{inboundOrderItem.processWay},
                #{inboundOrderItem.handleCategory}, #{inboundOrderItem.remarks},
                #{inboundOrderItem.warehouseArea}, #{inboundOrderItem.recordState}, #{inboundOrderItem.isQualified},
                #{inboundOrderItem.wastes.name},
                #{inboundOrderItem.wastes.wastesId}, #{inboundOrderItem.wastes.category},
                #{inboundOrderItem.wastesAmount}, #{inboundOrderItem.unitPriceTax}, #{inboundOrderItem.totalPrice},
                #{inboundOrderItem.laboratoryTest.laboratoryTestNumber}, 0);
            </foreach>
        </if>
        <if test="inboundOrderItemList.size() > 0">
        <foreach collection="inboundOrderItemList" item="inboundOrderItem" index="index">
            insert  into t_pl_wasteinventory(inboundOrderId,actualCount,clientId,wastesCode,inboundDate,processWay,handleCategory,creatorDate,boundType,transferDraftId,inboundOrderItemId,remarks,laboratoryTestId)
            values (#{inboundOrderItem.inboundOrderId},#{inboundOrderItem.wastesAmount}, #{inboundOrderItem.produceCompany.clientId},#{inboundOrderItem.wastes.wastesId},#{inboundDate}
            ,#{inboundOrderItem.processWay}, #{inboundOrderItem.handleCategory},#{createDate},#{boundType},#{inboundOrderItem.transferDraftId},#{inboundOrderItem.inboundOrderItemId},#{inboundOrderItem.remarks},#{inboundOrderItem.laboratoryTest.laboratoryTestNumber});
        </foreach>
        </if>
        <if test="inboundOrderItemList.size() > 0">
            <foreach collection="inboundOrderItemList" item="inboundOrderItem" index="index">
                insert into t_pl_wasteinto(clientId,wastesCode,handleCategory,processWay,remarks,nowTime,transferDraftId,wastesCategory,laboratoryTestId)
                values(#{inboundOrderItem.produceCompany.clientId},#{inboundOrderItem.wastes.wastesId},#{inboundOrderItem.handleCategory},#{inboundOrderItem.processWay},#{inboundOrderItem.remarks},NOW(),#{inboundOrderItem.transferDraftId},#{inboundOrderItem.wastes.category},#{inboundOrderItem.laboratoryTest.laboratoryTestNumber});
            </foreach>
        </if>
    </insert>

    <!--增加次生入库单-->
    <insert id="addSecondInboundOrder" parameterType="InboundOrder">
        INSERT INTO t_pl_inboundorder (inboundOrderId, inboundDate, warehouseId, boundType, keeperId, directorId, approverId, checkState, remarks, creatorId, createDate, departmentId, companyId, modifierId,
        modifyDate, recordState, category) VALUES (#{inboundOrderId}, NOW(), #{wareHouse.warehouseId}, #{boundType},
        #{keeperId}, #{directorId}, #{approverId}, #{checkState}, #{remarks},
        #{creatorId}, NOW(), #{departmentId}, #{companyId}, #{modifierId}, NOW(),
        #{recordState}, 1);
        <if test="inboundOrderItemList.size() > 0">
            <foreach collection="inboundOrderItemList" item="inboundOrderItem" index="index">
                INSERT INTO t_pl_inboundorderitem (inboundOrderItemId, transferDraftId, inboundOrderId,
                produceCompanyId, processWay, handleCategory,
                remarks, warehouseArea, recordState, isQualified, wastesName, wastesCode, wastesCategory, wastesAmount,
                unitPriceTax,
                totalPrice, laboratoryTestId, category) VALUES (#{inboundOrderItem.inboundOrderItemId}, #{inboundOrderItem.transferDraftId},
                #{inboundOrderId},
                #{inboundOrderItem.produceCompany.clientId}, #{inboundOrderItem.processWay},
                #{inboundOrderItem.handleCategory}, #{inboundOrderItem.remarks},
                #{inboundOrderItem.warehouseArea}, #{inboundOrderItem.recordState}, #{inboundOrderItem.isQualified},
                #{inboundOrderItem.wastes.name},
                #{inboundOrderItem.wastes.wastesId}, #{inboundOrderItem.wastes.category},
                #{inboundOrderItem.wastesAmount}, #{inboundOrderItem.unitPriceTax}, #{inboundOrderItem.totalPrice},
                #{inboundOrderItem.laboratoryTest.laboratoryTestNumber}, 1);
            </foreach>
        </if>
        <if test="inboundOrderItemList.size() > 0">
            <foreach collection="inboundOrderItemList" item="inboundOrderItem" index="index">
                insert  into t_pl_wasteinventory(inboundOrderId,actualCount,clientId,wastesCode,inboundDate,processWay,handleCategory,creatorDate,boundType,transferDraftId,inboundOrderItemId,remarks,laboratoryTestId,wastesCategory,unitPriceTax)
                values (#{inboundOrderId},#{inboundOrderItem.wastesAmount}, #{inboundOrderItem.produceCompany.clientId},#{inboundOrderItem.wastes.wastesId},NOW(),
                #{inboundOrderItem.processWay}, #{inboundOrderItem.handleCategory},NOW(),#{boundType},#{inboundOrderItem.transferDraftId},#{inboundOrderItem.inboundOrderItemId},#{inboundOrderItem.remarks},#{inboundOrderItem.laboratoryTest.laboratoryTestNumber},
                #{inboundOrderItem.wastes.name},#{inboundOrderItem.unitPriceTax});
            </foreach>
        </if>
    </insert>

    <!--列出入库单-->
    <select id="listInboundOrder" resultMap="InboundOrderRM">
        SELECT * FROM t_pl_inboundorder WHERE boundType='WasteInbound';
    </select>

    <!--列出次生入库单-->
    <select id="listSecondInboundOrder" resultMap="InboundOrderRM">
        SELECT * FROM t_pl_inboundorder WHERE boundType='SecondaryInbound';
    </select>

    <!--通过编号获取入库单-->
    <select id="getInboundOrderById" resultMap="InboundOrderRM">
        SELECT * FROM t_pl_inboundorder WHERE inboundOrderId=#{inboundOrderId};
    </select>

    <!--作废该入库单-->
    <update id="setInboundOrderStateInvalid" parameterType="String">
        UPDATE t_pl_inboundorder SET checkState='Invalid' WHERE inboundOrderId=#{inboundOrderId};
    </update>

    <!--获取入库单明细列表-->
    <select id="getInboundOrderItemList" resultMap="InboundOrderItemRM">
        SELECT * FROM t_pl_inboundorderitem WHERE inboundOrderId=#{inboundOrderId};
    </select>

    <!--判断是否存在该入库单号-->
    <select id="existInboundOrderId" resultType="boolean">
        SELECT COUNT(*) FROM t_pl_inboundorder WHERE inboundOrderId=#{inboundOrderId};
    </select>

    <update id="updateItemHandleCategory" parameterType="InboundOrderItem">
        UPDATE t_pl_inboundorderitem SET handleCategory=#{handleCategory} WHERE inboundOrderItemId=#{inboundOrderItemId};
    </update>

    <select id="countInboundOrder" resultType="int">
        SELECT COUNT(*) FROM t_pl_inboundorder WHERE boundType='WasteInbound';
    </select>

    <select id="countSecondInboundOrder" resultType="int">
        SELECT COUNT(*) FROM t_pl_inboundorder WHERE boundType='SecondaryInbound';
    </select>
</mapper>