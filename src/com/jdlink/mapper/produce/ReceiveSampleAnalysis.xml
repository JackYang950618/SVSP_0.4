<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.produce.ReceiveSampleAnalysisMapper" >

    <resultMap id="ReceiveSampleAnalysisRM" type="ReceiveSampleAnalysis" autoMapping="true">
        <id property="id" column="id"/>
        <association property="produceCompany" column="produceCompanyId" select="getProduceCompany"/>
    </resultMap>

    <select id="getProduceCompany" resultType="Client">
        select * from client where clientId=#{produceCompanyId};
    </select>

    <!--获取市场部化验单-->
    <select id="get" resultMap="ReceiveSampleAnalysisRM">
        SELECT * FROM t_pr_receivesampleanalysis
        <where>
            <if test="receiveSampleAnalysis != null and receiveSampleAnalysis.keyword != null and receiveSampleAnalysis.keyword != ''">
                and id LIKE "%"#{receiveSampleAnalysis.keyword}"%" or dispatcher like "%"#{receiveSampleAnalysis.keyword}"%" or destination like "%"#{receiveSampleAnalysis.keyword}"%"
                or transferTime like binary "%"#{receiveSampleAnalysis.keyword}"%" or produceCompanyName like "%"#{receiveSampleAnalysis.keyword}"%"
                or transportCompanyName like "%"#{receiveSampleAnalysis.keyword}"%" or acceptCompanyName like "%"#{receiveSampleAnalysis.keyword}"%"
            </if>
            <if test="receiveSampleAnalysis != null and receiveSampleAnalysis.id != null and receiveSampleAnalysis.id != ''">
                and id LIKE "%"#{receiveSampleAnalysis.id}"%"
            </if>
            <if test="receiveSampleAnalysis != null and receiveSampleAnalysis.produceCompany != null and receiveSampleAnalysis.produceCompany.companyName != null and receiveSampleAnalysis.produceCompany.companyName != ''">
                and produceCompanyName LIKE "%"#{receiveSampleAnalysis.produceCompany.companyName}"%"
            </if>

        </where>
        order by createTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <!--获取市场部化验单数量-->
    <select id="count" resultType="int">
        SELECT count(*) FROM t_pr_receivesampleanalysis
        <where>
            <if test="keyword != null and keyword != ''">
                and id LIKE "%"#{keyword}"%" or dispatcher like "%"#{keyword}"%" or destination like "%"#{keyword}"%"
                or transferTime like binary "%"#{keyword}"%" or produceCompanyName like "%"#{keyword}"%"
                or transportCompanyName like "%"#{keyword}"%" or acceptCompanyName like "%"#{keyword}"%"
            </if>
            <if test="id != null and id != ''">
                and id LIKE "%"#{id}"%"
            </if>
            <if test="produceCompany != null and produceCompany.companyName != null and produceCompany.companyName != ''">
                and produceCompanyName LIKE "%"#{produceCompany.companyName}"%"
            </if>

        </where>
    </select>

    <!--增加市场部化验单-->
    <insert id="add">
        insert into t_pr_receivesampleanalysis (id, transferDraftId, sampleId, finishDate,
        produceCompanyId, wastesName, wastesCode, handleCategory, formType, heat, PH, ash,
        water, fluorine, chlorine, sulfur, phosphorus, flashPoint, viscosity, hotMelt,
        remark, checkState, wastesCategory) values (#{id}, #{transferDraftId}, #{sampleId},
        #{finishDate}, #{produceCompany.clientId}, #{wastesName}, #{wastesCode}, #{handleCategory},
        #{formType}, #{heat}, #{PH}, #{ash}, #{water}, #{fluorine}, #{chlorine}, #{sulfur},
        #{phosphorus}, #{flashPoint}, #{viscosity}, #{hotMelt}, #{remark}, #{checkState},
        #{wastesCategory});
    </insert>

    <!--更新仓储部化验单-->
    <update id="update">
        update t_pr_receivesampleanalysis set transferDraftId=#{transferDraftId},
        sampleId=#{sampleId}, finishDate=#{finishDate}, produceCompanyId=#{produceCompany.clientId},
        wastesName=#{wastesName}, wastesCode=#{wastesCode}, handleCategory=#{handleCategory},
        formType=#{formType}, heat=#{heat}, PH=#{PH}, ash=#{ash}, water=#{water}, fluorine=#{fluorine},
        chlorine=#{chlorine}, sulfur=#{sulfur}, phosphorus=#{phosphorus}, flashPoint=#{flashPoint},
        viscosity=#{viscosity}, hotMelt=#{hotMelt}, remark=#{remark}, wastesCategory=#{wastesCategory}
        where id=#{id};
    </update>

    <!--设置状态-->
    <update id="setState">
        update t_pr_receivesampleanalysis set checkState=#{checkState}, id=concat(#{id}, #{newId}) where id=#{id};
    </update>

</mapper>