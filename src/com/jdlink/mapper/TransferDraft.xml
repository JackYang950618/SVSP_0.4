<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.TransferDraftMapper">
    <resultMap id="WastesRM" type="Wastes" autoMapping="true">
        <result property="id" column="id"/>
        <result property="formType" column="formType" javaType="com.jdlink.domain.FormType"/>
        <result property="packageType" column="packageType" javaType="com.jdlink.domain.PackageType"/>
    </resultMap>
    <resultMap id="TransferDraftRM" type="TransferDraft" autoMapping="true">
        <association property="produceCompany" column="produceCompanyId" select="getProduceCompany"/>
        <association property="transportCompany" column="transportCompanyId" select="getTransportCompany"/>
        <association property="acceptCompany" column="acceptCompanyId" select="getAcceptCompany"/>
        <association property="wastes" column="wastesId" select="getWastes"/>
    </resultMap>
    <insert id="add" parameterType="TransferDraft" >
        INSERT INTO t_pr_transferdraft (id, checkState, produceCompanyId, transportCompanyId, acceptCompanyId,
        wastesId, outwardIsTransit, outwardIsUse, outwardIsDeal, outwardIsDispose, mainDangerComponent,
        dangerCharacter, emergencyMeasure, emergencyEquipment, dispatcher, destination, transferTime,
        firstCarrier, firstCarryTime, firstModel, firstBrand, firstTransportNumber, firstOrigin, firstStation,
        firstDestination, firstCarrierSign, secondCarrier, secondCarryTime, secondModel, secondBrand,
        secondTransportNumber, secondOrigin, secondStation, secondDestination, secondCarrierSign,
        acceptCompanyLicense, recipient, acceptDate, disposeIsUse, disposeIsStore, disposeIsBurn,
        disposeIsLandFill, disposeIsOther, headSign, signDate, nowTime) VALUES (#{id}, #{checkState}, #{produceCompany.clientId},
        #{transportCompany.supplierId}, #{acceptCompany.clientId}, #{wastes.id}, #{outwardIsTransit}, #{outwardIsUse},
        #{outwardIsDeal}, #{outwardIsDispose}, #{mainDangerComponent}, #{dangerCharacter}, #{emergencyMeasure},
        #{emergencyEquipment}, #{dispatcher}, #{destination}, #{transferTime}, #{firstCarrier},
        #{firstCarryTime}, #{firstModel}, #{firstBrand}, #{firstTransportNumber}, #{firstOrigin}, #{firstStation},
        #{firstDestination}, #{firstCarrierSign}, #{secondCarrier}, #{secondCarryTime}, #{secondModel}, #{secondBrand},
        #{secondTransportNumber}, #{secondOrigin}, #{secondStation}, #{secondDestination}, #{secondCarrierSign},
        #{acceptCompanyLicense}, #{recipient}, #{acceptDate}, #{disposeIsUse}, #{disposeIsStore}, #{disposeIsBurn},
        #{disposeIsLandFill}, #{disposeIsOther}, #{headSign}, #{signDate}, NOW());

        INSERT INTO t_wastes (id, name, category, code, prepareTransferCount, transferCount, signCount, wastesCharacter,
        formType, packageType) VALUES (#{wastes.id}, #{wastes.name}, #{wastes.category}, #{wastes.code},
        #{wastes.prepareTransferCount}, #{wastes.transferCount}, #{wastes.signCount}, #{wastes.wastesCharacter},
        #{wastes.formType}, #{wastes.packageType});
    </insert>

    <select id="getById" parameterType="String" resultMap="TransferDraftRM">
        SELECT t_pr_transferdraft.* FROM t_pr_transferdraft WHERE t_pr_transferdraft.id=#{id};
    </select>

    <select id="getProduceCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{produceCompanyId};
    </select>
    <select id="getAcceptCompany" parameterType="String" resultType="Client">
        SELECT * FROM client WHERE clientId=#{acceptCompanyId};
    </select>
    <select id="getTransportCompany" parameterType="String" resultType="Supplier">
        SELECT * FROM t_supplier WHERE supplierId=#{transportCompanyId};
    </select>
    <select id="getWastes" parameterType="String" resultMap="WastesRM">
        SELECT * FROM t_wastes WHERE id=#{wastesId};
    </select>

    <update id="update" parameterType="TransferDraft" >
        UPDATE t_pr_transferdraft SET produceCompanyId=#{produceCompany.clientId}, transportCompanyId=#{transportCompany.supplierId},
        acceptCompanyId=#{acceptCompany.clientId}, outwardIsTransit=#{outwardIsTransit},
        outwardIsUse=#{outwardIsUse}, outwardIsDeal=#{outwardIsDeal}, outwardIsDispose=#{outwardIsDispose},
        mainDangerComponent=#{mainDangerComponent}, dangerCharacter=#{dangerCharacter}, emergencyMeasure=#{emergencyMeasure},
        emergencyEquipment=#{emergencyEquipment}, dispatcher=#{dispatcher}, destination=#{destination},
        transferTime=#{transferTime}, firstCarrier=#{firstCarrier}, firstCarryTime=#{firstCarryTime}, firstModel=#{firstModel}, firstBrand=#{firstBrand},
        firstTransportNumber=#{firstTransportNumber}, firstOrigin=#{firstOrigin}, firstStation=#{firstStation},
        firstDestination=#{firstDestination}, firstCarrierSign=#{firstCarrierSign}, secondCarrier=#{secondCarrier},
        secondCarryTime=#{secondCarryTime}, secondModel=#{secondModel}, secondBrand=#{secondBrand}, secondTransportNumber=#{secondTransportNumber},
        secondOrigin=#{secondOrigin}, secondStation=#{secondStation}, secondDestination=#{secondDestination},
        secondCarrierSign=#{secondCarrierSign}, acceptCompanyLicense=#{acceptCompanyLicense}, recipient=#{recipient},
        acceptDate=#{acceptDate}, disposeIsUse=#{disposeIsUse}, disposeIsStore=#{disposeIsStore}, disposeIsBurn=#{disposeIsBurn},
        disposeIsLandFill=#{disposeIsLandFill}, disposeIsOther=#{disposeIsOther}, headSign=#{headSign}, signDate=#{signDate},
        nowTime=NOW() WHERE id=#{id};

        UPDATE t_wastes SET name=#{wastes.name}, category=#{wastes.category}, code=#{wastes.code}, prepareTransferCount=#{wastes.prepareTransferCount},
        transferCount=#{wastes.transferCount}, signCount=#{wastes.signCount}, wastesCharacter=#{wastes.wastesCharacter}, formType=#{wastes.formType},
        packageType=#{wastes.packageType} WHERE id=#{wastes.id};
    </update>

    <update id="setStateInvalid" parameterType="String">
        UPDATE t_pr_transferdraft SET checkState='Invalid' WHERE id=#{id};
    </update>

    <select id="list" resultType="TransferDraft">
        SELECT * FROM t_pr_transferdraft ORDER BY nowTime DESC
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="count" resultType="int">
        SELECT COUNT(*) FROM t_pr_transferdraft;
    </select>

    <select id="search" parameterType="TransferDraft" resultType="TransferDraft">
        SELECT * FROM t_pr_transferdraft
        <where>
            <if test="keyword != null and keyword != ''">
                and companyName like "%"#{keyword}"%" or clientId like "%"#{keyword}"%"
                or contactName like "%"#{keyword}"%" or phone like "%"#{keyword}"%"
            </if>
            <if test="id != null and id != ''">
                and id LIKE "%"#{id}"%"
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="searchCount" parameterType="TransferDraft" resultType="int">
        SELECT COUNT(*) FROM t_pr_transferdraft
        <where>
            <if test="keyword != null and keyword != ''">
                and companyName like "%"#{keyword}"%" or clientId like "%"#{keyword}"%"
                or contactName like "%"#{keyword}"%" or phone like "%"#{keyword}"%"
            </if>
            <if test="id != null and id != ''">
                and id LIKE "%"#{id}"%"
            </if>
        </where>
    </select>
</mapper>