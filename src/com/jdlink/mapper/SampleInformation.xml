<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.SampleInformationMapper">
    <resultMap id="SampleInformationRM" type="SampleInformation" autoMapping="true">
        <id property="id" column="id"/>
        <result property="companyCode" column="companyCode"/>
        <result property="applyState" column="applyState"/>
        <result property="laboratorySigner" column="laboratorySigner"/>
        <collection property="wastesList" select="getWastes" column="id" ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>

    <insert id="add" parameterType="SampleInformation">
        INSERT INTO t_pr_sampleinformation (id,companyCode, wastesCode,applyState,laboratorySigner,isPH,isAsh,isWater,isHeat,isSulfur,isChlorine,isFluorine,isPhosphorus,isFlashPoint,isViscosity,nowTime)
        VALUES (#{id},#{companyCode},#{wastesList[0].code},'Appointed',#{laboratorySigner},#{wastesList[0].isPH}, #{wastesList[0].isAsh}, #{wastesList[0].isWater}, #{wastesList[0].isHeat},
        #{wastesList[0].isSulfur}, #{wastesList[0].isChlorine}, #{wastesList[0].isFluorine}, #{wastesList[0].isPhosphorus}, #{wastesList[0].isFlashPoint}, #{wastesList[0].isViscosity}, NOW());
        <if test="wastesList.size() > 0">
            <foreach collection="wastesList" item="wastes" index="index">
                INSERT INTO t_wastes (id,sampleId,code,isPH,isAsh,isWater,isHeat,isSulfur,isChlorine,isFluorine,isPhosphorus,isFlashPoint,isViscosity) VALUES
                (#{wastes.id}, #{id}, #{wastes.code},#{wastes.isPH}, #{wastes.isAsh}, #{wastes.isWater}, #{wastes.isHeat},
                #{wastes.isSulfur}, #{wastes.isChlorine}, #{wastes.isFluorine}, #{wastes.isPhosphorus}, #{wastes.isFlashPoint}, #{wastes.isViscosity});
            </foreach>
        </if>
</insert>

    <select id="listPage" resultType="SampleInformation">
        select *
        from t_pr_sampleinformation ORDER BY nowTime DESC
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="count" resultType="int">
        select count(*) from t_pr_sampleinformation;
    </select>

    <select id="wastesCount" resultType="int">
        select count(*) from t_wastes;
    </select>

    <select id="getByWastesId" parameterType="String" resultType="Wastes">
        SELECT * FROM t_wastes WHERE id = #{id}
    </select>

    <select id="getBySampleInformationId" parameterType="String" resultMap="SampleInformationRM">
        SELECT * FROM t_pr_sampleinformation WHERE id = #{id}
    </select>

    <select id="getById" resultMap="SampleInformationRM">
        select * from t_pr_sampleinformation WHERE id = #{sampleId} ORDER BY nowTime DESC;
    </select>

    <select id="listByKeyword" parameterType="String" resultType="SampleInformation">
        select * from t_pr_sampleinformation
        <where>
            <if test='1 == 1'>
                companyCode LIKE "%"#{keyword}"%" or wastesCode like "%"#{keyword}"%" or laboratorySigner like "%"#{keyword}"%"
            </if>
            <if test='keyword == "已"'>
                or applyState = 'SampleTaked' or applyState = 'Appointed'
            </if>
            <if test='keyword == "预约"'>
                or applyState =  'Appointed' or applyState = 'Canceld'
            </if>
            <if test='keyword == "已取样" || keyword == "取样"'>
                or applyState = 'SampleTaked'
            </if>
            <if test='keyword== "已预约"'>
                or applyState =  'Appointed'
            </if>
            <if test='keyword == "预约取消"'>
                or applyState = 'Canceld'
            </if>
        </where>
        ORDER BY nowTime DESC;
    </select>

    <select id="searchCount" parameterType="SampleInformation" resultType="int">
        SELECT COUNT(*) FROM t_pr_sampleinformation
        <where>
            <if test="keyword != null and keyword != ''">
                and companyCode LIKE "%"#{keyword}"%" or wastesCode like "%"#{keyword}"%" or laboratorySigner like "%"#{keyword}"%"
            </if>
            <if test='keyword == "已"'>
                or applyState = 'SampleTaked' or applyState = 'Appointed'
            </if>
            <if test='keyword == "预约"'>
                or applyState =  'Appointed' or applyState = 'Canceld'
            </if>
            <if test='keyword == "已取样" || keyword == "取样"'>
                or applyState = 'SampleTaked'
            </if>
            <if test='keyword== "已预约"'>
                or applyState =  'Appointed'
            </if>
            <if test='keyword == "预约取消"'>
                or applyState = 'Canceld'
            </if>
            <if test='companyCode != null and companyCode != ""'>
                and companyCode LIKE "%"#{companyCode}"%"
            </if>
            <if test='wastesCode != null and wastesCode != ""'>
                and wastesCode LIKE "%"#{wastesCode}"%"
            </if>
            <if test='applyState != null and applyState != ""'>
                and applyState LIKE "%"#{applyState}"%"
            </if>
            <if test='laboratorySigner != null and laboratorySigner != ""'>
                and laboratorySigner LIKE "%"#{laboratorySigner}"%"
            </if>
            <if test='isPH != null and isPH != ""'>
                and isPH = #{isPH}
            </if>
            <if test='isAsh != null and isAsh != ""'>
                and isAsh = #{isAsh}
            </if>
            <if test='isWater != null and isWater != ""'>
                and isWater = #{isWater}
            </if>
            <if test='isHeat != null and isHeat != ""'>
                and isHeat = #{isHeat}
            </if>
            <if test='isSulfur != null and isSulfur != ""'>
                and isSulfur = #{isSulfur}
            </if>
            <if test='isChlorine != null and isChlorine != ""'>
                and isChlorine = #{isChlorine}
            </if>
            <if test='isFluorine != null and isFluorine != ""'>
                and isFluorine = #{isFluorine}
            </if>
            <if test='isPhosphorus != null and isPhosphorus != ""'>
                and isPhosphorus = #{isPhosphorus}
            </if>
            <if test='isFlashPoint != null and isFlashPoint != ""'>
                and isFlashPoint = #{isFlashPoint}
            </if>
            <if test='isViscosity != null and isViscosity != ""'>
                and isViscosity = #{isViscosity}
            </if>
        </where>
    </select>

    <select id="search" parameterType="SampleInformation" resultType="SampleInformation">
        SELECT * FROM t_pr_sampleinformation
        <where>
            <if test="keyword != null and keyword != ''">
                and companyCode LIKE "%"#{keyword}"%" or wastesCode like "%"#{keyword}"%" or laboratorySigner like "%"#{keyword}"%"
            </if>
            <if test='keyword == "已"'>
                or applyState = 'SampleTaked' or applyState = 'Appointed'
            </if>
            <if test='keyword == "预约"'>
                or applyState =  'Appointed' or applyState = 'Canceld'
            </if>
            <if test='keyword == "已取样" || keyword == "取样"'>
                or applyState = 'SampleTaked'
            </if>
            <if test='keyword== "已预约"'>
                or applyState =  'Appointed'
            </if>
            <if test='keyword == "预约取消"'>
                or applyState = 'Canceld'
            </if>
            <if test='companyCode != null and companyCode != ""'>
                and companyCode LIKE "%"#{companyCode}"%"
            </if>
            <if test='wastesCode != null and wastesCode != ""'>
                and wastesCode LIKE "%"#{wastesCode}"%"
            </if>
            <if test='applyState != null and applyState != ""'>
                and applyState LIKE "%"#{applyState}"%"
            </if>
            <if test='laboratorySigner != null and laboratorySigner != ""'>
                and laboratorySigner LIKE "%"#{laboratorySigner}"%"
            </if>
            <if test='isPH != null and isPH != ""'>
                and isPH = #{isPH}
            </if>
            <if test='isAsh != null and isAsh != ""'>
                and isAsh = #{isAsh}
            </if>
            <if test='isWater != null and isWater != ""'>
                and isWater = #{isWater}
            </if>
            <if test='isHeat != null and isHeat != ""'>
                and isHeat = #{isHeat}
            </if>
            <if test='isSulfur != null and isSulfur != ""'>
                and isSulfur = #{isSulfur}
            </if>
            <if test='isChlorine != null and isChlorine != ""'>
                and isChlorine = #{isChlorine}
            </if>
            <if test='isFluorine != null and isFluorine != ""'>
                and isFluorine = #{isFluorine}
            </if>
            <if test='isPhosphorus != null and isPhosphorus != ""'>
                and isPhosphorus = #{isPhosphorus}
            </if>
            <if test='isFlashPoint != null and isFlashPoint != ""'>
                and isFlashPoint = #{isFlashPoint}
            </if>
            <if test='isViscosity != null and isViscosity != ""'>
                and isViscosity = #{isViscosity}
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count}
        </if>
    </select>

    <select id="getWastes" resultType="Wastes" parameterType="String">
        SELECT * FROM t_wastes WHERE sampleId=#{id}
    </select>

    <update id="confirmCheck" parameterType="String">
        UPDATE t_pr_sampleinformation SET applyState = 'SampleTaked',nowTime = NOW(),samplingDate = NOW() WHERE id = #{sampleId}
    </update>

    <update id="update" parameterType="SampleInformation">
        UPDATE t_pr_sampleinformation SET wastesCode = #{wastesList[0].code},laboratorySigner = #{laboratorySigner},isPH = #{wastesList[0].isPH},
        isAsh = #{wastesList[0].isAsh},isWater = #{wastesList[0].isWater},isHeat = #{wastesList[0].isHeat},isSulfur = #{wastesList[0].isSulfur},isChlorine = #{wastesList[0].isChlorine},
        isFluorine = #{wastesList[0].isFluorine},isPhosphorus = #{wastesList[0].isPhosphorus},isFlashPoint = #{wastesList[0].isFlashPoint},isViscosity = #{wastesList[0].isViscosity},nowTime = NOW()
        WHERE t_pr_sampleinformation.id =#{id};
        <if test="wastesList.size() > 0">
            <foreach collection="wastesList" item="wastes" index="index">
                UPDATE t_wastes SET code = #{wastes.code},isPH = #{wastes.isPH},
                isAsh =  #{wastes.isAsh},isWater = #{wastes.isWater},isHeat = #{wastes.isHeat},isSulfur = #{wastes.isSulfur},
                isChlorine = #{wastes.isChlorine},isFluorine = #{wastes.isFluorine},isPhosphorus = #{wastes.isPhosphorus},
                isFlashPoint = #{wastes.isFlashPoint},isViscosity = #{wastes.isViscosity}
                WHERE t_wastes.id = #{wastes.id};
            </foreach>
        </if>
    </update>

    <update id="updateSampleInfo" parameterType="String">
        update t_pr_sampleinformation set applyState = 'Invalid' where id = #{sampleId}
    </update>



</mapper>