<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.IngredientsMapper">
    <!-- 入库单-->
    <resultMap id="IngredientsInRM" type="IngredientsIn" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getInItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="InIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="inId" property="id"/>
        <result column="procurementId" property="procurementId"/>
        <result column="serialNumberIn" property="serialNumber"/>
    </resultMap>

    <select id="getInItems" parameterType="String" resultMap="InIngredientsRM">
        select * from t_pr_ingredients where inId = #{id};
    </select>

    <select id="countInById" resultType="int">
        select count(*) from t_pr_ingredients_in where id like "%"#{id}"%";
    </select>

    <select id="countIn" resultType="int">
        select count(*) from t_pr_ingredients_in;
    </select>

    <select id="countInItem" resultType="int">
       select count(*) from t_pr_ingredients join t_pr_ingredients_in on inId=id;
    </select>

    <select id="listPageIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in order by creationDate desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageInItem" resultMap="InIngredientsRM">
        select a.*,b.companyName,b.creationDate,b.state from t_pr_ingredients as a join t_pr_ingredients_in as b on
        a.inId=b.id order by creationDate desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getInById" parameterType="String" resultMap="IngredientsInRM">
          select * from t_pr_ingredients_in where id = #{id};
     </select>

    <select id="searchIn" parameterType="IngredientsIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInItem" parameterType="Ingredients" resultMap="InIngredientsRM">
        select a.*,b.companyName,b.creationDate,b.state from t_pr_ingredients as a join t_pr_ingredients_in as b on
        a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.inId like "%"#{keywords}"%"
                or b.companyName like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.totalPrice like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and inId like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
            <if test="name !=null and name !='' ">
                and name like "%"#{name}"%"
            </if>
            <if test="specification !=null and specification !='' ">
                and specification like "%"#{specification}"%"
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_in as b on a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.inId like "%"#{keywords}"%"
                or b.companyName like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.totalPrice like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and inId like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
            <if test="name !=null and name !='' ">
                and name like "%"#{name}"%"
            </if>
            <if test="specification !=null and specification !='' ">
                and specification like "%"#{specification}"%"
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInCount" parameterType="IngredientsIn" resultType="int">
        select count(*) from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
    </select>

    <select id="getIngredientsInItemByRange" resultMap="InIngredientsRM">
        select * from t_pr_ingredients
        <where>
            inId in (SELECT id FROM t_pr_ingredients_in
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
                and equipment = #{equipment};
            </if>
        </where>
    </select>

    <select id="getAmountItems" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory
        where name = #{name} and wareHouseName = #{wareHouseName} and specification=#{specification};
    </select>

    <update id="invalidIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in set state = 'Invalid' where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pl_material set state = 'ToInbound'
                where receiptNumber =#{ingredients.procurementId} and suppliesName=#{ingredients.name} and
                specifications=#{ingredients.specification};

                update t_pr_ingredients_inventory
                set amount= amount - #{ingredients.amount}
                where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                specification=#{ingredients.specification};
            </foreach>
        </if>
    </update>

    <update id="updateIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in
        set
        companyName=#{companyName},fileId=#{fileId},totalPrice=#{totalPrice},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},acceptor=#{acceptor},handlers=#{handlers},nowTime=NOW()
        where id = #{id};

        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},equipment=#{ingredients.equipment}
                where inId = #{ingredients.id} and serialNumberIn = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <!--修改入库单-->
    <update id="updateDataIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in
        set companyName=#{companyName},creationDate=#{creationDate},fileId=#{fileId},totalPrice=#{totalPrice},
        bookkeeper=#{bookkeeper},approver=#{approver},keeper=#{keeper},acceptor=#{acceptor},handlers=#{handlers},
        nowTime=NOW()
        where id=#{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                <if test="ingredients.aid == 'notExist'"><!--不存在则新增-->
                    insert into t_pr_ingredients_inventory
                    (name,wareHouseName,amount,unit,ingredientState,specification)
                    values
                    (#{ingredients.name},#{ingredients.wareHouseName},#{ingredients.amount},#{ingredients.unit},'ToReceive',
                    #{ingredients.specification});
                </if>
                <if test="ingredients.aid == 'exist'"><!--存在则更新-->
                    update t_pr_ingredients_inventory
                    set
                    amount = amount + #{ingredients.amount}
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                    specification=#{ingredients.specification};
                </if>
                <if test="ingredients.serialNumberA == 'add'"><!--新增-->
                    update t_pl_material set state = 'ToPick' where
                    id=#{ingredients.procurementItemId};

                    insert into t_pr_ingredients
                    (inId,serialNumberIn,name,unitPrice,totalPrice,amount,wareHouseName,post,specification,unit,
                    ingredientState,remarks,equipment,procurementId)
                    values
                    (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                    #{ingredients.totalPrice},#{ingredients.amount},#{ingredients.wareHouseName},
                    #{ingredients.post},#{ingredients.specification},#{ingredients.unit},'ToReceive',#{ingredients.remarks},
                    #{ingredients.equipment},#{ingredients.procurementId});
                </if>
                <if test="ingredients.serialNumberA == 'update'"><!--更新-->
                    update t_pr_ingredients
                    set
                    unitPrice=#{ingredients.unitPrice},post=#{ingredients.post},wareHouseName=#{ingredients.wareHouseName},equipment=#{ingredients.equipment},
                    where itemId=#{ingredients.itemId};
                </if>
                <if test="ingredients.serialNumberA == 'del'"><!--删除，并回退之前的数据-->
                    delete from t_pr_ingredients where itemId=#{ingredients.itemId};

                    update t_pl_material set state = 'ToInbound'
                    where receiptNumber =#{ingredients.procurementId} and suppliesName=#{ingredients.name} and
                    specifications=#{ingredients.specification};

                    update t_pr_ingredients_inventory
                    set amount= amount - #{ingredients.amount}
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                    specification=#{ingredients.specification};
                </if>
            </foreach>
        </if>
    </update>

    <insert id="addIn" parameterType="IngredientsIn">
        <!--<if test="procurementItemIdList != null and procurementItemIdList.size() > 0">-->
        <!--<foreach index="index" item="procurementItemId" collection="procurementItemIdList">-->
        <!--update t_pl_materialsetstate = 'ToPick'where id = #{procurementItemId};-->
        <!--</foreach>-->
        <!--</if>-->
        insert into
        t_pr_ingredients_in
        (id,companyName,creationDate,fileId,totalPrice,bookkeeper,approver,keeper,acceptor,handlers,state,nowTime)
        values
        (#{id},#{companyName},#{creationDate},#{fileId},#{totalPrice},#{bookkeeper},#{approver},#{keeper},#{acceptor},
        #{handlers},'NewBuild',NOW());
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach index="index" item="ingredients" collection="ingredientsList">
                update t_pl_material set state = 'ToPick' where id = #{ingredients.procurementItemId};

                insert into
                t_pr_ingredients(inId,serialNumberIn,name,unitPrice,totalPrice,amount,wareHouseName,post,specification,
                unit,ingredientState,remarks,equipment,procurementId)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.amount},#{ingredients.wareHouseName},#{ingredients.post},
                #{ingredients.specification},#{ingredients.unit},'ToReceive',#{ingredients.remarks},#{ingredients.equipment},
                #{ingredients.procurementId});
                <choose>
                    <when test="ingredients.aid != 'exist'">
                        insert into
                        t_pr_ingredients_inventory(name,wareHouseName,amount,unit,ingredientState,specification)
                        values
                        (#{ingredients.name},#{ingredients.wareHouseName},#{ingredients.amount},#{ingredients.unit},
                        'ToReceive',#{ingredients.specification});
                    </when>
                    <otherwise>
                        update t_pr_ingredients_inventory
                        set
                        amount = amount + #{ingredients.amount}
                        where
                        name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                        specification=#{ingredients.specification};
                    </otherwise>
                </choose>
            </foreach>
        </if>
    </insert>


    <!--领料单-->
    <resultMap id="IngredientsReceiveRM" type="IngredientsReceive" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getReceiveItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="ReceiveIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="receiveId" property="id"/>
        <result column="serialNumberReceive" property="serialNumber"/>
    </resultMap>

    <select id="getReceiveItems" parameterType="String" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients where receiveId = #{id};
    </select>

    <select id="countReceiveById" resultType="int">
        select count(*) from t_pr_ingredients_receive where id like "%"#{id}"%";
    </select>

    <select id="countReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive;
    </select>

    <select id="countReceiveItem" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id;
    </select>

    <select id="listPageReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive order by creationDate desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageReceiveItem" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id
        order by b.id desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getReceiveById" parameterType="String" resultMap="IngredientsReceiveRM">
          select * from t_pr_ingredients_receive where id = #{id};
     </select>

    <select id="searchReceive" parameterType="IngredientsReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchReceiveCount" parameterType="IngredientsReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
    </select>

    <select id="searchReceiveItem" parameterType="Ingredients" resultMap="ReceiveIngredientsRM">
        select a.*,b.state,b.department,b.creationDate from t_pr_ingredients as a join t_pr_ingredients_receive as b on
        a.receiveId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="department != null and department != ''">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
        </where>
        order by b.id desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchReceiveItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="department != null and department != ''">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
        </where>
    </select>


    <select id="getAmountAndReceive" parameterType="Ingredients" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients_inventory where name=#{name} and wareHouseName=#{wareHouseName};
    </select>

    <select id="getInventoryList" resultType="Ingredients">
        select * from t_pr_ingredients_inventory
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count};
        </if>
    </select>

    <select id="countInventory" resultType="int">
        select count(*) from t_pr_ingredients_inventory;
    </select>

    <select id="getInventoryByNameAndWare" resultType="Ingredients">
        select * from t_pr_ingredients_inventory where name = #{name} and wareHouseName = #{wareHouseName} and specification=#{specification};
    </select>

    <select id="searchInventoryCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory
        <where>
            <if test="keywords != null and keywords != ''">
                or itemId = #{keywords}
                or name like "%"#{keywords}"%"
                or wareHouseName like "%"#{keywords}"%"
                or amount like "%"#{keywords}"%"
                or unit like "%"#{keywords}"%"
                or ingredientState like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="name != null and name != ''">
                name like "%"#{name}"%"
            </if>
            <if test="amount != null and amount != ''">
                amount = #{amount}
            </if>
        </where>
    </select>

    <select id="searchInventory" resultType="Ingredients">
        select * from t_pr_ingredients_inventory
        <where>
            <if test="keywords != null and keywords != ''">
                or itemId = #{keywords}
                or name like "%"#{keywords}"%"
                or wareHouseName like "%"#{keywords}"%"
                or amount like "%"#{keywords}"%"
                or unit like "%"#{keywords}"%"
                or ingredientState like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="name != null and name != ''">
                name like "%"#{name}"%"
            </if>
            <if test="amount != null and amount != ''">
                amount = #{amount}
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <update id="invalidReceive" parameterType="IngredientsReceive">
        update t_pr_ingredients_receive set state = 'Invalid' where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index"><!--将库存加回-->
                update t_pr_ingredients_inventory
                set amount= amount + #{ingredients.receiveAmount}
                where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                specification=#{ingredients.specification};
            </foreach>
        </if>
    </update>

    <update id="updateReceive" parameterType="IngredientsReceive"><!--导入用修改-->
        update t_pr_ingredients_receive
        set
        department=#{department},fileId=#{fileId},totalAmount=#{totalAmount},vicePresident=#{vicePresident},warehouseSupervisor=#{warehouseSupervisor},
        keeper=#{keeper},pickingSupervisor=#{pickingSupervisor},pickingMan=#{pickingMan},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},amount=0,wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},
                specification=#{ingredients.specification},unit=#{ingredients.unit},remarks=#{ingredients.remarks},receiveAmount=#{ingredients.receiveAmount},
                ingredientState=IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received')
                where receiveId = #{ingredients.id} and serialNumberReceive = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <!--修改功能-->
    <update id="updateDataReceive" parameterType="IngredientsReceive">
        update t_pr_ingredients_receive
        set
        department=#{department},fileId=#{fileId},totalAmount=#{totalAmount},vicePresident=#{vicePresident},warehouseSupervisor=#{warehouseSupervisor},
        keeper=#{keeper},pickingSupervisor=#{pickingSupervisor},pickingMan=#{pickingMan},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                <if test="ingredients.serialNumberA == 'update'"><!--更新-->
                    <if test="ingredients.keywords == 'plus'"><!--新领料数比旧的小则需增加库存-->
                        update t_pr_ingredients_inventory
                        set amount= amount + #{ingredients.notReceiveAmount}
                        where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                        specification=#{ingredients.specification};
                    </if>
                    <if test="ingredients.keywords == 'reduce'"><!--新领料数比旧的大则需减少库存-->
                        update t_pr_ingredients_inventory
                        set amount= amount - #{ingredients.notReceiveAmount}
                        where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                        specification=#{ingredients.specification};
                    </if>
                    update t_pr_ingredients
                    set
                    remarks=#{ingredients.remarks},receiveAmount=#{ingredients.receiveAmount},ingredientState='PartReceived'
                    where itemId=#{ingredients.itemId};
                </if>
                <if test="ingredients.serialNumberA == 'add'"><!--新增-->
                    insert into t_pr_ingredients
                    (receiveId,serialNumberReceive,name,receiveAmount,wareHouseName,
                    specification,unit,remarks,ingredientState)
                    values
                    (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},
                    #{ingredients.receiveAmount},#{ingredients.wareHouseName},#{ingredients.specification},
                    #{ingredients.unit},#{ingredients.remarks},IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received'));

                    update t_pr_ingredients_inventory
                    set amount= amount - #{ingredients.receiveAmount}
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                    specification=#{ingredients.specification};
                </if>
                <if test="ingredients.serialNumberA == 'del'"><!--减少-->
                    update t_pr_ingredients_inventory
                    set amount= amount + #{ingredients.receiveAmount}
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                    specification=#{ingredients.specification};

                    delete from t_pr_ingredients where itemId=#{ingredients.itemId}
                </if>
            </foreach>
        </if>
    </update>

    <update id="updateReceiveState" parameterType="String">
        update t_pr_ingredients_receive
        set
        state = 'OutBounded'
        where id = #{id};
    </update>

    <insert id="addAllReceive" parameterType="IngredientsReceive">
        insert into t_pr_ingredients_receive
        (id, department,creationDate,fileId,totalAmount,vicePresident,warehouseSupervisor,keeper,
        pickingSupervisor,pickingMan,state,nowTime)
        values
        (#{id},#{department},NOW(),#{fileId},#{totalAmount},#{vicePresident},#{warehouseSupervisor},#{keeper},
        #{pickingSupervisor},#{pickingMan},'NewBuild',NOW());
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (receiveId,serialNumberReceive,name,receiveAmount,wareHouseName,
                specification,unit,remarks,ingredientState)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},
                #{ingredients.receiveAmount},#{ingredients.wareHouseName},#{ingredients.specification},
                #{ingredients.unit},#{ingredients.remarks},IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received'));

                update t_pr_ingredients_inventory
                set
                amount =
                amount-#{ingredients.receiveAmount},ingredientState=IF((amount-#{ingredients.receiveAmount})>0,'PartReceived','Received')
                where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
            </foreach>
        </if>
    </insert>

    <!-- 出库单-->
    <resultMap id="IngredientsOutRM" type="IngredientsOut" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getOutItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="OutIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="aid" property="aid"/>
        <result column="outId" property="id"/>
        <result column="serialNumberOut" property="serialNumber"/>
    </resultMap>

    <select id="getOutItems" parameterType="String" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients where outId = #{id};
    </select>

    <select id="countOutById" resultType="int">
        select count(*) from t_pr_ingredients_out where id like "%"#{id}"%";
    </select>

    <select id="countOut" resultType="int">
        select count(*) from t_pr_ingredients_out;
    </select>

    <select id="countOutItem" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id;
    </select>

    <select id="listPageOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out order by creationDate desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageOutItem" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getIngredientsOutItemByRange" resultMap="OutIngredientsRM">
        SELECT * FROM t_pr_ingredients
        <where>
            outId in (SELECT id FROM t_pr_ingredients_out
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
                AND equipment = #{equipment};
            </if>
        </where>
    </select>

    <select id="getOutById" parameterType="String" resultMap="IngredientsOutRM">
          select * from t_pr_ingredients_out where id = #{id};
     </select>

    <select id="searchOut" parameterType="IngredientsOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchOutCount" parameterType="IngredientsOut" resultType="int">
        select count(*) from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
    </select>

    <select id="searchOutItem" parameterType="Ingredients" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.receiveAmount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.post like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
                or a.equipment like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="department != '' and department != null">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
        </where>
        order by creationDate desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchOutItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.receiveAmount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.post like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
                or a.equipment like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="department != '' and department != null">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
        </where>
    </select>

    <update id="invalidOut" parameterType="String">
        update t_pr_ingredients_out set state = 'Invalid' where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                <!--将领料单状态重置为新建-->
                update t_pr_ingredients_receive
                set state='NewBuild'
                where id=#{ingredients.aid};

                <!--将领料单物品明细状态更新为部分领用-->
                update t_pr_ingredients set ingredientState='PartReceived' where receiveId=#{ingredients.aid};
            </foreach>
        </if>
    </update>

    <update id="updateOut" parameterType="IngredientsOut">
        update t_pr_ingredients_out
        set
        department=#{department},fileId=#{fileId},totalPrice=#{totalPrice},totalAmount=#{totalAmount},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},handlers=#{handlers},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList != null and ingredientsList != '' and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},ingredientState=IF(#{ingredients.notReceiveAmount}=1,'PartOutBound','OutBounded'),
                equipment=#{ingredients.equipment}
                where outId = #{ingredients.id} and serialNumberOut = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <update id="updateDataOut" parameterType="IngredientsOut">
        update t_pr_ingredients_out
        set
        department=#{department},fileId=#{fileId},totalPrice=#{totalPrice},totalAmount=#{totalAmount},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},handlers=#{handlers},creationDate=#{creationDate},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList != null and ingredientsList != '' and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                <if test="ingredients.serialNumberA == 'add'"><!--新增-->
                    insert into t_pr_ingredients
                    (outId,serialNumberOut,name,unitPrice,totalPrice,receiveAmount,wareHouseName,post,
                    specification,unit,ingredientState,remarks,equipment,aid)
                    values
                    (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                    #{ingredients.totalPrice},#{ingredients.receiveAmount},#{ingredients.wareHouseName},
                    #{ingredients.post},#{ingredients.specification},#{ingredients.unit},
                    IF(#{ingredients.notReceiveAmount}>0,'PartOutBound','OutBounded'),#{ingredients.remarks},#{ingredients.equipment},
                    #{ingredients.aid});
                </if>
                <if test="ingredients.serialNumberA == 'update'"><!--修改-->
                    update t_pr_ingredients
                    set unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},post=#{ingredients.post},
                    equipment=#{ingredients.equipment}
                    where itemId=#{ingredients.itemId}
                </if>
                <if test="ingredients.serialNumberA == 'del'"><!--删除-->
                    update t_pr_ingredients_receive
                    set state='NewBuild'
                    where id=#{ingredients.aid};

                    update t_pr_ingredients
                    set ingredientState='PartReceived'
                    where receiveId=#{ingredients.aid} and name=#{ingredients.name} and specification=#{ingredients.specification}
                    and wareHouseName=#{ingredients.wareHouseName};
                </if>
            </foreach>
        </if>
    </update>

    <insert id="addOut" parameterType="IngredientsOut">
        insert into t_pr_ingredients_out
        (id,department,creationDate,fileId,totalPrice,totalAmount,bookkeeper,approver,keeper,
        handlers,state,nowTime)
        values
        (#{id},#{department},#{creationDate},#{fileId},#{totalPrice},#{totalAmount},#{bookkeeper},#{approver},#{keeper},
        #{handlers},'NewBuild',NOW());
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (outId,serialNumberOut,name,unitPrice,totalPrice,receiveAmount,wareHouseName,post,
                specification,unit,ingredientState,remarks,equipment,aid)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.receiveAmount},#{ingredients.wareHouseName},
                #{ingredients.post},#{ingredients.specification},#{ingredients.unit},
                IF(#{ingredients.notReceiveAmount}>0,'PartOutBound','OutBounded'),#{ingredients.remarks},#{ingredients.equipment},
                #{ingredients.aid});

                <if test="receiveIdList == null or receiveIdList.size() == 0">
                    update t_pr_ingredients_inventory
                    set
                    amount =
                    amount-#{ingredients.receiveAmount},ingredientState=IF((amount-#{ingredients.receiveAmount})>0,'PartReceived','Received')
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
                </if>
            </foreach>
        </if>
        <if test="receiveIdList != null and receiveIdList.size() > 0 ">
            <foreach collection="receiveIdList" item="receiveId" index="index">
                update t_pr_ingredients_receive
                set
                state = 'OutBounded'
                where id = #{receiveId};
            </foreach>
        </if>
    </insert>

</mapper>