<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.IngredientsMapper">
    <!-- 入库单-->
    <resultMap id="IngredientsInRM" type="IngredientsIn" autoMapping="true">
        <id column="id" property="id"/>
        <association property="checkStateItem" column="checkStateId" select="getCheckStateItem"/>
        <collection property="ingredientsList" select="getInItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="InIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="inId" property="id"/>
        <result column="unit" property="unit"/>
        <result column="creationDate" property="creationDate"/>
        <result column="procurementId" property="procurementId"/>
        <result column="serialNumberIn" property="serialNumber"/>
        <association property="checkStateItem" column="checkStateId" select="getCheckStateItem"/>
    </resultMap>

    <!--获得处置设备数据字典-->
    <select id="getEquipmentDataItem" resultType="EquipmentDataItem">
          select * from datadictionaryitem where dataDictionaryItemId=#{equipmentId}
    </select>
    <!--获取状态数据字典-->
    <select id="getIngredientStateItem" resultType="IngredientStateItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{ingredientStateId}
    </select>

    <select id="getInItems" parameterType="String" resultMap="InIngredientsRM">
        select * from t_pr_ingredients where inId = #{id};
    </select>

    <select id="countInById" resultType="int">
        select count(*) from t_pr_ingredients_in where id like "%"#{id}"%";
    </select>

    <select id="countIn" resultType="int">
        select count(*) from t_pr_ingredients_in;
    </select>

    <select id="countInItem" resultType="int">
       select count(*) from t_pr_ingredients join t_pr_ingredients_in on inId=id;
    </select>

    <select id="listPageIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in
        where checkStateId != 69
        order by creationTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageInItem" resultMap="InIngredientsRM">
        select a.*,b.companyName,b.creationDate,b.state,b.checkStateId from t_pr_ingredients as a join
        t_pr_ingredients_in as b on
        a.inId=b.id
        where b.checkStateId != 69
        order by creationTime desc,serialNumberIn ASC
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getInById" parameterType="String" resultMap="IngredientsInRM">
          select * from t_pr_ingredients_in where id = #{id};
     </select>

    <select id="searchIn" parameterType="IngredientsIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%" and dataDictionaryId=11)
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where
                    dictionaryItemName=#{checkStateItem.dictionaryItemName} )
                </if>
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInItem" parameterType="Ingredients" resultMap="InIngredientsRM">
        select a.*,b.companyName,b.creationDate,b.state,b.checkStateId from t_pr_ingredients as a join
        t_pr_ingredients_in as b on
        a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.inId like "%"#{keywords}"%"
                or b.companyName like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.code like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.totalPrice like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and inId like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and code like #{code}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
            <if test="name !=null and name !='' ">
                and name like "%"#{name}"%"
            </if>
            <if test="specification !=null and specification !='' ">
                and specification like "%"#{specification}"%"
            </if>
            <if test="amount !=null and amount !='' ">
                and amount = #{amount}
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_in as b on a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.inId like "%"#{keywords}"%"
                or b.companyName like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.code like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.totalPrice like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and inId like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and code like "%"#{code}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
            <if test="name !=null and name !='' ">
                and name like "%"#{name}"%"
            </if>
            <if test="specification !=null and specification !='' ">
                and specification like "%"#{specification}"%"
            </if>
            <if test="amount !=null and amount !='' ">
                and amount = #{amount}
            </if>
        </where>
    </select>

    <select id="searchInCount" parameterType="IngredientsIn" resultType="int">
        select count(*) from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%" and dataDictionaryId=11)
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where
                    dictionaryItemName=#{checkStateItem.dictionaryItemName} )
                </if>

            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
    </select>

    <select id="getIngredientsInItemByRange" resultMap="InIngredientsRM">
        select * from t_pr_ingredients
        <where>
            inId in (SELECT id FROM t_pr_ingredients_in
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
                and equipment = #{equipment};
            </if>
        </where>
    </select>

    <!--根据签订日期范围查询辅料入库明细:统计图表-->
    <select id="getIngredientsInItemAmountByRange" resultMap="InIngredientsRM">
        select SUM(a.amount) as amount,b.creationDate from t_pr_ingredients as a left join t_pr_ingredients_in as b on
        a.inId=b.id
        <where>
            <if test="startDate != null and startDate != ''">
                <![CDATA[AND DATE_FORMAT(b.creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')]]>
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[AND DATE_FORMAT(b.creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
            </if>
            <if test="1==1">
                AND b.checkStateId != 69
            </if>
        </where>
        GROUP BY DATE_FORMAT(b.creationDate, '%Y%m') ORDER BY b.creationDate ASC;
    </select>

    <select id="getAmountItems" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory
        where name = #{name} and wareHouseName = #{wareHouseName} and specification=#{specification};
    </select>

    <update id="invalidIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in set checkStateId = 69 where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pl_material set stateId = 77
                where receiptNumber =#{ingredients.procurementId} and suppliesName=#{ingredients.name} and
                specifications=#{ingredients.specification};

                delete from t_pr_ingredients_inventory where inId=#{id};
            </foreach>
        </if>
    </update>

    <update id="updateIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in
        set
        companyName=#{companyName},fileId=#{fileId},totalPrice=#{totalPrice},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},acceptor=#{acceptor},handlers=#{handlers},nowTime=NOW()
        where id = #{id};

        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},code=#{ingredients.code},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},equipment=#{ingredients.equipment},equipmentId=#{ingredients.equipmentDataItem.dataDictionaryItemId}
                where inId = #{ingredients.id} and serialNumberIn = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <!--修改入库单-->
    <update id="updateDataIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in
        set companyName=#{companyName},creationDate=#{creationDate},fileId=#{fileId},totalPrice=#{totalPrice},
        bookkeeper=#{bookkeeper},approver=#{approver},keeper=#{keeper},acceptor=#{acceptor},handlers=#{handlers},
        nowTime=NOW()
        where id=#{id};
    </update>

    <!--暂不用-->
    <insert id="addInventoryItem" parameterType="Ingredients">
        insert into t_pr_ingredients_inventory
        (name,wareHouseName,amount,unit,ingredientState,ingredientStateId,specification,code,inId,inItemId,inAmount,inPrice,creationTime)
        values
        (#{name},#{wareHouseName},#{amount},#{unit},'ToReceive',7,#{specification},#{code},#{inId},#{inItemId},#{inAmount},#{inPrice},NOW());
    </insert>

    <insert id="addIngredientsInItem" parameterType="Ingredients">
         insert into t_pr_ingredients
         (inId,serialNumberIn,name,unitPrice,totalPrice,amount,wareHouseName,post,specification,unit,
         ingredientState,ingredientStateId,remarks,equipment,equipmentId,procurementId)
         values
         (#{id},#{serialNumber},#{name},#{unitPrice},#{totalPrice},#{amount},#{wareHouseName},
         #{post},#{specification},#{unit},'ToReceive',7,#{remarks},#{equipment},#{equipmentDataItem.dataDictionaryItemId},#{procurementId});

          insert into t_pr_ingredients_inventory
          (name,wareHouseName,amount,unit,ingredientStateId,specification,code,inId,inItemId,inAmount,inPrice,creationTime)
          values
          (#{ingredients.name},#{ingredients.wareHouseName},#{ingredients.amount},#{ingredients.unit},38,
          #{ingredients.specification},#{ingredients.code},#{#{ingredients.id}},
          #{ingredients.inItemId},#{ingredients.amount},#{ingredients.unitPrice},NOW());

          update t_pl_material set stateId = 77 where id=#{procurementItemId};
    </insert>

    <!--暂不用-->
    <update id="addInventoryAmount" parameterType="Ingredients">
        update t_pr_ingredients_inventory
        set
        amount = amount + #{amount}
        where name=#{name} and wareHouseName=#{wareHouseName} and specification=#{specification};
    </update>

    <update id="updateIngredientInItem" parameterType="Ingredients">
         update t_pr_ingredients
         set
         unitPrice=#{unitPrice},post=#{post},wareHouseName=#{wareHouseName},totalPrice=#{totalPrice},amount=#{amount}
         where itemId=#{itemId};

         update t_pr_ingredients_inventory
         set
         inPrice=#{unitPrice},wareHouseName=#{wareHouseName},amount=#{amount},inAmount=#{amount}
         where inId=#{id} and name=#{name} and specification=#{specification} and wareHouseName=#{oldWareHouseName};
    </update>

    <delete id="delIngredientInItem" parameterType="Ingredients">
        delete from t_pr_ingredients where itemId=#{itemId};

        update t_pl_material set stateId = 77
        where receiptNumber =#{procurementId} and suppliesName=#{name} and specifications=#{specification};

        delete from t_pr_ingredients_inventory
        where inId=#{id} and name=#{name} and wareHouseName=#{wareHouseName} and specification=#{specification};
    </delete>

    <delete id="deleteInventory">
        delete from t_pr_ingredients_inventory;
    </delete>

    <update id="reduceOldInventory" parameterType="Ingredients">
        update t_pr_ingredients_inventory
        set amount= amount - #{amount}
        where inId=#{id} and name=#{name} and wareHouseName=#{oldWareHouseName} and specification=#{specification};
    </update>

    <insert id="addIn" parameterType="IngredientsIn">
        insert into
        t_pr_ingredients_in
        (id,companyName,creationDate,fileId,totalPrice,bookkeeper,approver,keeper,acceptor,handlers,state,nowTime,creationTime,checkStateId)
        values
        (#{id},#{companyName},#{creationDate},#{fileId},#{totalPrice},#{bookkeeper},#{approver},#{keeper},#{acceptor},
        #{handlers},'NewBuild',NOW(),NOW(),75);
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach index="index" item="ingredients" collection="ingredientsList">
                update t_pr_procumentplanitem set ingredientStateId =36 where id = #{ingredients.procurementItemId};

                insert into
                t_pr_ingredients(inId,serialNumberIn,code,name,unitPrice,totalPrice,amount,wareHouseName,post,specification,
                unit,unitId,ingredientState,remarks,equipmentId,procurementId,ingredientStateId)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.code},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.amount},#{ingredients.wareHouseName},#{ingredients.post},
                #{ingredients.specification},#{ingredients.unit},#{ingredients.unitDataItem.dataDictionaryItemId},'ToReceive',
                #{ingredients.remarks},#{ingredients.equipmentDataItem.dataDictionaryItemId},
                #{ingredients.procurementId},38);

                insert into t_pr_ingredients_inventory
                (name,wareHouseName,amount,unit,ingredientStateId,specification,code,inId,inItemId,inAmount,inPrice,creationTime)
                values
                (#{ingredients.name},#{ingredients.wareHouseName},#{ingredients.amount},#{ingredients.unit},38,#{ingredients.specification},#{ingredients.code},#{ingredients.id},
                #{ingredients.inItemId},#{ingredients.amount},#{ingredients.unitPrice},NOW());
            </foreach>
        </if>
    </insert>


    <!--领料单-->
    <resultMap id="IngredientsReceiveRM" type="IngredientsReceive" autoMapping="true">
        <id column="id" property="id"/>
        <association property="checkStateItem" column="checkStateId" select="getCheckStateItem"></association>
        <collection property="ingredientsList" select="getReceiveItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>

    </resultMap>
    <!--获取状态数据字典-->
    <select id="getCheckStateItem" resultType="CheckStateItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{checkStateId}
    </select>

    <resultMap id="ReceiveIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="receiveId" property="id"/>
        <result column="serialNumberReceive" property="serialNumber"/>
        <association property="checkStateItem" column="checkStateId" select="getCheckStateItem"/>
    </resultMap>

    <select id="getReceiveItems" parameterType="String" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients where receiveId = #{id};
    </select>

    <select id="countReceiveById" resultType="int">
        select count(*) from t_pr_ingredients_receive where id like "%"#{id}"%";
    </select>

    <select id="countReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive;
    </select>

    <select id="countReceiveItem" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id;
    </select>

    <select id="listPageReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive
        where checkStateId != 69
        order by creationTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageReceiveItem" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id
        where b.checkStateId != 69
        order by b.creationTime desc,serialNumberReceive ASC
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getReceiveById" parameterType="String" resultMap="IngredientsReceiveRM">
          select * from t_pr_ingredients_receive where id = #{id};
     </select>

    <select id="searchReceive" parameterType="IngredientsReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%")
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName =
                    #{checkStateItem.dictionaryItemName})
                </if>

            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchReceiveCount" parameterType="IngredientsReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in (select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%")
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName =
                    #{checkStateItem.dictionaryItemName})
                </if>

            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
    </select>

    <select id="searchReceiveItem" parameterType="Ingredients" resultMap="ReceiveIngredientsRM">
        select a.*,b.state,b.department,b.creationDate,b.checkStateId from t_pr_ingredients as a join
        t_pr_ingredients_receive as b on
        a.receiveId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.code like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and a.code like "%"#{code}"%"
            </if>
            <if test="department != null and department != ''">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
        </where>
        order by b.creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchReceiveItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_receive as b on a.receiveId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or b.state like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.code like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.amount like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and a.code like "%"#{code}"%"
            </if>
            <if test="department != null and department != ''">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and  DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
                <![CDATA[ and  DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
        </where>
    </select>


    <select id="getAmountAndReceive" parameterType="Ingredients" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients_inventory where name=#{name} and wareHouseName=#{wareHouseName};
    </select>

    <!--获取库存/收发汇总表数据-->
    <select id="getInventoryList" resultType="Ingredients">
        select a.*,b.creationDate as creationDate from t_pr_ingredients_inventory as a join t_pr_ingredients_in as b on
        a.inId=b.id
        order by inId DESC,itemId asc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count};
        </if>
    </select>

    <!--收发汇总表获取合计数据-->
    <select id="getSumByIngredient" parameterType="Ingredients" resultType="Ingredients">
        select sum(amount) as totalAmount,sum(amount*inPrice) as allTotalPrice,sum(inAmount)
        as inTotalAmount,sum(inAmount*inPrice) as inTotalPrice,
        sum(outAmount) as outTotalAmount,sum(outAmount*outPrice) as outTotalPrice,
        (select sum(amount)
        from t_pr_ingredients_inventory as a1 left join t_pr_ingredients_in as b1 on a1.inId=b1.id
        where DATE_FORMAT(DATE_SUB(#{creationDate},INTERVAL 1 MONTH),'%Y-%m-%d') >= DATE_FORMAT(b1.creationDate,'%Y-%m-%d')
        and a1.name=#{name} and a1.specification=#{specification} and a1.wareHouseName=#{wareHouseName})  as monthBeginAmount,
        (select sum(amount*inPrice)
        from t_pr_ingredients_inventory as a1 left join t_pr_ingredients_in as b1 on a1.inId=b1.id
        where DATE_FORMAT(DATE_SUB(#{creationDate},INTERVAL 1 MONTH),'%Y-%m-%d') >= DATE_FORMAT(b1.creationDate,'%Y-%m-%d')
        and a1.name=#{name} and a1.specification=#{specification} and a1.wareHouseName=#{wareHouseName}) as monthBeginTotalPrice
        from t_pr_ingredients_inventory as a1 left join t_pr_ingredients_in as b1 on a1.inId=b1.id
        where DATE_FORMAT(#{creationDate},'%Y-%m-%d') >= DATE_FORMAT(b1.creationDate,'%Y-%m-%d')
        and a1.name=#{name} and a1.specification=#{specification} and a1.wareHouseName=#{wareHouseName}
    </select>

    <select id="countInventory" resultType="int">
        select count(*) from t_pr_ingredients_inventory;
    </select>

    <select id="getInventoryByNameAndWare" resultType="Ingredients">
        select * from t_pr_ingredients_inventory where receiveId=#{receiveId} and name = #{name} and wareHouseName = #{wareHouseName} and specification=#{specification};
    </select>

    <select id="searchInventoryCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory as a left join t_pr_ingredients_in as b on a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.itemId = #{keywords}
                or a.code like #{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or a.inId like "%"#{keywords}"%"
                or a.outId like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="code != null and code != ''">
                and a.code like #{code}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification = #{specification}
            </if>
            <if test="unit != null and unit != ''">
                and a.unit = #{unit}
            </if>
            <if test="inId != null and inId != ''">
                and a.inId like "%"#{inId}"%"
            </if>
            <if test="outId != null and outId != ''">
                and a.outId like "%"#{outId}"%"
            </if>
            <if test="amount != null and amount != ''">
                and a.amount =#{amount}
            </if>
            <if test="inAmount != null and inAmount != ''">
                and a.inAmount =#{inAmount}
            </if>
        </where>
    </select>

    <select id="searchInventory" resultType="Ingredients">
        select a.*,b.creationDate from t_pr_ingredients_inventory as a left join t_pr_ingredients_in as b on a.inId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or a.itemId = #{keywords}
                or a.code like #{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or a.inId like "%"#{keywords}"%"
                or a.outId like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="code != null and code != ''">
                and a.code like #{code}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification = #{specification}
            </if>
            <if test="unit != null and unit != ''">
                and a.unit = #{unit}
            </if>
            <if test="inId != null and inId != ''">
                and a.inId like "%"#{inId}"%"
            </if>
            <if test="outId != null and outId != ''">
                and a.outId like "%"#{outId}"%"
            </if>
            <if test="amount != null and amount != ''">
                and a.amount =#{amount}
            </if>
            <if test="inAmount != null and inAmount != ''">
                and a.inAmount =#{inAmount}
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <update id="invalidReceive" parameterType="IngredientsReceive">
        update t_pr_ingredients_receive set checkStateId = 69 where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index"><!--将库存加回-->
                update t_pr_ingredients_inventory
                set amount= amount +
                #{ingredients.receiveAmount},receiveAmount=receiveAmount-#{ingredients.receiveAmount},ingredientStateId=38
                where receiveId=#{id} and name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName} and
                specification=#{ingredients.specification};
            </foreach>
        </if>
    </update>

    <update id="updateReceive" parameterType="IngredientsReceive"><!--导入用修改-->
        update t_pr_ingredients_receive
        set
        department=#{department},fileId=#{fileId},totalAmount=#{totalAmount},vicePresident=#{vicePresident},warehouseSupervisor=#{warehouseSupervisor},
        keeper=#{keeper},pickingSupervisor=#{pickingSupervisor},pickingMan=#{pickingMan},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},amount=0,wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},
                specification=#{ingredients.specification},unit=#{ingredients.unit},remarks=#{ingredients.remarks},receiveAmount=#{ingredients.receiveAmount},
                ingredientState=IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received'),ingredientStateId=IF(#{ingredients.notReceiveAmount}>0,40,39)
                where receiveId = #{ingredients.id} and serialNumberReceive = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <!--修改功能-->
    <update id="updateDataReceive" parameterType="IngredientsReceive">
        update t_pr_ingredients_receive
        set
        department=#{department},fileId=#{fileId},totalAmount=#{totalAmount},vicePresident=#{vicePresident},warehouseSupervisor=#{warehouseSupervisor},
        keeper=#{keeper},pickingSupervisor=#{pickingSupervisor},pickingMan=#{pickingMan},nowTime=NOW(),creationDate=#{creationDate}
        where id = #{id};
    </update>

    <insert id="addIngredientsReceiveItem" parameterType="Ingredients">
        insert into t_pr_ingredients
        (receiveId,serialNumberReceive,code,name,receiveAmount,amount,unitPrice,totalPrice,wareHouseName,
        specification,unit,remarks,post,ingredientStateId)
        values
        (#{id},#{serialNumber},#{code},#{name},#{receiveAmount},#{amount},#{unitPrice},#{totalPrice},#{wareHouseName},#{specification},
        #{unit},#{remarks},#{post},IF(#{ingredients.notReceiveAmount}>0,40,39));

         update t_pr_ingredients_inventory
         set amount=amount-#{receiveAmount},ingredientStateId=IF((amount-#{receiveAmount})>0,40,39),
         receiveId = #{id},receiveAmount=receiveAmount+#{receiveAmount},receivePrice=#{unitPrice}
         where itemId=#{itemId};
    </insert>

    <update id="updateIngredientsReceiveItem" parameterType="Ingredients">
        update t_pr_ingredients
        set
        remarks=#{remarks},post=#{post},receiveAmount=#{receiveAmount},ingredientStateId=40,
        serialNumberReceive=#{serialNumber},unitPrice=#{unitPrice},totalPrice=#{totalPrice},
        where itemId=#{itemId};
    </update>

    <update id="plusInventoryAmount" parameterType="Ingredients">
        update t_pr_ingredients_inventory
        set amount= amount + (#{oldReceiveAmount}-#{receiveAmount})
        where receiveId=#{id} and name=#{name} and wareHouseName=#{wareHouseName} and specification=#{specification};
    </update>

    <update id="reduceInventoryAmount" parameterType="Ingredients">
        update t_pr_ingredients_inventory
        set amount= amount - (#{receiveAmount}-#{oldReceiveAmount})
        where receiveId=#{id} and name=#{name} and wareHouseName=#{wareHouseName} and specification=#{specification};
    </update>

    <delete id="delIngredientReceiveItem" parameterType="Ingredients">
        update t_pr_ingredients_inventory
        set amount= amount + #{receiveAmount}
        where receiveId=#{id} and name=#{name} and wareHouseName=#{wareHouseName} and specification=#{specification};

        delete from t_pr_ingredients where itemId=#{itemId}
    </delete>

    <update id="updateReceiveState" parameterType="String">
        update t_pr_ingredients_receive
        set
        state = 'OutBounded',checkStateId=81
        where id = #{id};
    </update>

    <insert id="addAllReceive" parameterType="IngredientsReceive">
        insert into t_pr_ingredients_receive
        (id,department,creationDate,fileId,totalAmount,totalPrice,vicePresident,warehouseSupervisor,keeper,
        pickingSupervisor,pickingMan,state,nowTime,creationTime,checkStateId)
        values
        (#{id},#{department},#{creationDate},#{fileId},#{totalAmount},#{totalPrice},#{vicePresident},
        #{warehouseSupervisor},#{keeper},#{pickingSupervisor},#{pickingMan},'NewBuild',NOW(),NOW(),75);
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (receiveId,serialNumberReceive,code,name,unitPrice,totalPrice,receiveAmount,amount,wareHouseName,
                specification,unit,post,remarks,ingredientStateId)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.code},#{ingredients.name},
                #{ingredients.unitPrice},#{ingredients.totalPrice},#{ingredients.receiveAmount},#{ingredients.amount},
                #{ingredients.wareHouseName},#{ingredients.specification},#{ingredients.unit},
                #{ingredients.post},#{ingredients.remarks},IF(#{ingredients.notReceiveAmount}>0,40,39));

                update t_pr_ingredients_inventory
                set
                amount=amount-#{ingredients.receiveAmount},ingredientStateId=IF((amount-#{ingredients.receiveAmount})>0,40,39),
                receiveId=#{ingredients.id},receiveAmount=receiveAmount+#{ingredients.receiveAmount},receivePrice=#{ingredients.unitPrice}
                where itemId=#{ingredients.itemId};
            </foreach>
        </if>
    </insert>

    <!-- 出库单-->
    <resultMap id="IngredientsOutRM" type="IngredientsOut" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getOutItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="OutIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="aid" property="aid"/>
        <result column="outId" property="id"/>
        <result column="serialNumberOut" property="serialNumber"/>
        <result column="creationDate" property="creationDate"/>
        <association property="equipmentDataItem" column="equipmentId" select="getEquipmentDataItem"/>
        <association property="checkStateItem" column="checkStateId" select="getCheckStateItem"/>
    </resultMap>

    <select id="getOutItems" parameterType="String" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients where outId = #{id};
    </select>

    <select id="countOutById" resultType="int">
        select count(*) from t_pr_ingredients_out where id like "%"#{id}"%";
    </select>

    <select id="countOut" resultType="int">
        select count(*) from t_pr_ingredients_out;
    </select>

    <select id="countOutItem" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id;
    </select>

    <select id="listPageOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out
        where checkStateId != 69
        order by creationTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="listPageOutItem" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        where b.checkStateId != 69
        order by b.creationTime desc,serialNumberOut ASC
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getIngredientsOutItemByRange" resultMap="OutIngredientsRM">
        SELECT * FROM t_pr_ingredients
        <where>
            outId in (SELECT id FROM t_pr_ingredients_out
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
                AND equipment = #{equipment};
            </if>
        </where>
    </select>

    <!--根据签订日期范围查询辅料出库明细:统计图表-->
    <select id="getIngredientsOutItemAmountByRange" resultMap="InIngredientsRM">
        select SUM(a.receiveAmount) as receiveAmount,b.creationDate from t_pr_ingredients as a left join
        t_pr_ingredients_out as b on a.outId=b.id
        <where>
            <if test="startDate != null and startDate != ''">
                <![CDATA[AND DATE_FORMAT(b.creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')]]>
            </if>
            <if test="endDate != null and endDate != ''">
                <![CDATA[AND DATE_FORMAT(b.creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
            </if>
            <if test="1==1">
                AND b.checkStateId != 69
            </if>
        </where>
        GROUP BY DATE_FORMAT(b.creationDate, '%Y%m') ORDER BY b.creationDate ASC;
    </select>

    <select id="getOutById" parameterType="String" resultMap="IngredientsOutRM">
          select * from t_pr_ingredients_out where id = #{id};
     </select>

    <select id="searchOut" parameterType="IngredientsOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%")
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName
                    =#{checkStateItem.dictionaryItemName})
                </if>

            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchOutCount" parameterType="IngredientsOut" resultType="int">
        select count(*) from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%")
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="checkStateItem != null">
                <if test="checkStateItem.dictionaryItemName!=''">
                    and checkStateId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName
                    =#{checkStateItem.dictionaryItemName})
                </if>

            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
    </select>

    <select id="searchOutItem" parameterType="Ingredients" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or code like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.receiveAmount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.post like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
                or a.equipment like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and code like "%"#{code}"%"
            </if>
            <if test="department != '' and department != null">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchOutItemCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients as a join t_pr_ingredients_out as b on a.outId=b.id
        <where>
            <if test="keywords != null and keywords != ''">
                or b.id like "%"#{keywords}"%"
                or b.department like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or code like "%"#{keywords}"%"
                or a.name like "%"#{keywords}"%"
                or a.specification like "%"#{keywords}"%"
                or a.wareHouseName like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or a.unit like "%"#{keywords}"%"
                or a.receiveAmount like "%"#{keywords}"%"
                or a.unitPrice like "%"#{keywords}"%"
                or a.post like "%"#{keywords}"%"
                or a.remarks like "%"#{keywords}"%"
                or a.equipment like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and b.id like "%"#{id}"%"
            </if>
            <if test="code != '' and code != null">
                and code like "%"#{code}"%"
            </if>
            <if test="department != '' and department != null">
                and b.department like "%"#{department}"%"
            </if>
            <if test="state != null and state !=''">
                and b.state like "%"#{state}"%"
            </if>
            <if test="name != null and name != ''">
                and a.name like "%"#{name}"%"
            </if>
            <if test="specification != null and specification != ''">
                and a.specification like "%"#{specification}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                and a.wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
        </where>
    </select>

    <update id="invalidOut" parameterType="String">
        update t_pr_ingredients_out set
        checkStateId = 69
        where id = #{id};
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                <!--将领料单状态重置为新建-->
                update t_pr_ingredients_receive
                set checkStateId=75
                where id=#{ingredients.aid};

                <!--将领料单物品明细状态更新为待出库-->
                update t_pr_ingredients set ingredientStateId=41 where receiveId=#{ingredients.aid};
            </foreach>
        </if>
    </update>

    <update id="updateOut" parameterType="IngredientsOut">
        update t_pr_ingredients_out
        set
        department=#{department},fileId=#{fileId},totalPrice=#{totalPrice},totalAmount=#{totalAmount},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},handlers=#{handlers},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList != null and ingredientsList != '' and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                code=#{code},name=#{ingredients.name},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},ingredientState=IF(#{ingredients.notReceiveAmount}=1,'PartOutBound','OutBounded'),
                ingredientStateId=IF(#{ingredients.notReceiveAmount}=1,43,42),equipment=#{ingredients.equipment},equipmentId=#{ingredients.equipmentDataItem.dataDictionaryItemId}
                where outId = #{ingredients.id} and serialNumberOut = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <update id="updateDataOut" parameterType="IngredientsOut">
        update t_pr_ingredients_out
        set
        department=#{department},fileId=#{fileId},totalPrice=#{totalPrice},totalAmount=#{totalAmount},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},handlers=#{handlers},creationDate=#{creationDate},nowTime=NOW()
        where id = #{id};
    </update>

    <insert id="addIngredientsOutItem" parameterType="Ingredients">
        insert into t_pr_ingredients
        (outId,serialNumberOut,code,name,unitPrice,totalPrice,receiveAmount,wareHouseName,post,
        specification,unit,ingredientStateId,remarks,equipment,aid)
        values
        (#{id},#{serialNumber},#{code},#{name},#{unitPrice},#{totalPrice},#{receiveAmount},#{wareHouseName},#{post},
        #{specification},#{unit},IF(#{notReceiveAmount}>0,43,42),#{remarks},#{equipment},#{aid});

        update t_pr_ingredients_receive
        set
        checkStateId = 81
        where id = #{aid};
    </insert>

    <update id="updateIngredientsOutItem" parameterType="Ingredients">
         update t_pr_ingredients
         set
         unitPrice=#{unitPrice},totalPrice=#{totalPrice},post=#{post},equipment=#{equipment}
         where itemId=#{itemId}
    </update>

    <delete id="delIngredientsOutItem" parameterType="Ingredients">
        update t_pr_ingredients_receive
        set checkStateId=75
        where id=#{aid};

        update t_pr_ingredients
        set ingredientStateId=40
        where receiveId=#{aid} ;

        delete from t_pr_ingredients
         where itemId=#{itemId} ;
    </delete>

    <insert id="addOut" parameterType="IngredientsOut">
        insert into t_pr_ingredients_out
        (id,department,creationDate,fileId,totalPrice,totalAmount,bookkeeper,approver,keeper,
        handlers,state,nowTime,creationTime,checkStateId)
        values
        (#{id},#{department},#{creationDate},#{fileId},#{totalPrice},#{totalAmount},#{bookkeeper},#{approver},#{keeper},
        #{handlers},'NewBuild',NOW(),NOW(),75);
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (outId,serialNumberOut,code,name,unitPrice,totalPrice,receiveAmount,wareHouseName,post,
                specification,unit,ingredientStateId,remarks,equipment,aid,equipmentId)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.code},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.receiveAmount},#{ingredients.wareHouseName},
                #{ingredients.post},#{ingredients.specification},#{ingredients.unit},
                IF(#{ingredients.notReceiveAmount}>0,43,42),#{ingredients.remarks},#{ingredients.equipment},
                #{ingredients.aid},#{ingredients.equipmentDataItem.dataDictionaryItemId});

                update t_pr_ingredients
                set ingredientStateId = 42
                where itemId=#{ingredients.receiveItemId};

                update t_pr_ingredients_inventory
                set outAmount=#{ingredients.receiveAmount},outId=#{ingredients.id},outPrice=#{ingredients.unitPrice}
                where receiveId=#{ingredients.receiveId} and specification=#{ingredients.specification}
                and name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
            </foreach>
        </if>
    </insert>

    <!--获取已结账的出库单的年月份集合-->
    <select id="getDateBbySettled" resultType="String">
          SELECT date_format(creationDate,'%Y-%m')  FROM t_pr_ingredients_out
          WHERE checkStateId=253;
    </select>

    <!--锁定出库单-->
    <update id="outSettled" parameterType="IngredientsOut">
        <if test="receiveIdList != null and receiveIdList.size() > 0">
            <foreach collection="receiveIdList" index="index" item="id">
                update t_pr_ingredients_out set checkStateId=253 where id=#{id};
            </foreach>
        </if>
    </update>

    <!--辅料备件物品维护-->
    <resultMap id="IngredientsRM" type="Ingredients" autoMapping="true">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <association property="materialCategoryItem" column="materialCategoryId"
                     select="getMaterialCategoryItem" />
        <association property="unitDataItem" column="unitId" select="getUnitId" />
    </resultMap>

   <!--辅料备件物品管理树状-->
    <resultMap id="IngredientsTreeRM" type="IngredientsTree" autoMapping="true">
        <id column="id" property="id" />
        <association property="materialCategoryItem" column="materialCategoryId"
                     select="getMaterialCategoryItem" />
        <association property="unitDataItem" column="unitId" select="getUnitId" />
    </resultMap>

    <!--获取和物资累呗数据字典-->
    <select id="getMaterialCategoryItem" resultType="MaterialCategoryItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{materialCategoryId}
    </select>

    <!--获取单位数据字典-->
    <select id="getUnitId" resultType="UnitDataItem">
        select * from datadictionaryitem where dataDictionaryItemId=#{unitId}
    </select>

    <select id="getIngredientsList" resultMap="IngredientsRM">
        select * from t_pl_ingredients_list_tree where materialCategoryId is not null
        order by creationTime desc,code asc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count};
        </if>
    </select>

    <select id="getCountIngredientsList" resultType="int">
        select count(*) from t_pl_ingredients_list_tree where materialCategoryId is not null;
    </select>

    <select id="getIngredientByNameAndSpecification" resultMap="IngredientsRM">
        select * from t_pl_ingredients_list_tree where name=#{name} and specification=#{specification} and materialCategoryId is not null;
    </select>

    <select id="getIngredientById" resultMap="IngredientsRM">
        select * from t_pl_ingredients_list_tree where id=#{id};
    </select>

    <select id="searchIngredient" parameterType="Ingredients" resultMap="IngredientsRM">
        select * from t_pl_ingredients_list_tree
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or name like "%"#{keywords}"%"
                or code like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
                or materialCategoryId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName
                like "%"#{keywords}"%" and dataDictionaryId=28)
                or unitId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%" and dataDictionaryId=25)
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="name != '' and name != null">
                and name like "%"#{name}"%"
            </if>
            <if test="code != '' and code != null">
                and code like "%"#{code}"%"
            </if>
            <if test="specification != '' and specification != null">
                and specification like "%"#{specification}"%"
            </if>
            <if test="materialCategoryItem!=null">
                <if test="materialCategoryItem.dataDictionaryItemId!=0">
                    and materialCategoryId=#{materialCategoryItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="1==1">
                and materialCategoryId is not null
            </if>
        </where>
        order by creationTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchCountIngredient" parameterType="Ingredients" resultType="int">
        select count(*) from t_pl_ingredients_list_tree
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or name like "%"#{keywords}"%"
                or code like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
                or materialCategoryId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName
                like "%"#{keywords}"%" and dataDictionaryId=28)
                or unitId in(select dataDictionaryItemId from datadictionaryitem where dictionaryItemName like
                "%"#{keywords}"%" and dataDictionaryId=25)
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="name != '' and name != null">
                and name like "%"#{name}"%"
            </if>
            <if test="code != '' and code != null">
                and code like "%"#{code}"%"
            </if>
            <if test="specification != '' and specification != null">
                and specification like "%"#{specification}"%"
            </if>
            <if test="materialCategoryItem!=null">
                <if test="materialCategoryItem.dataDictionaryItemId!=0">
                    and materialCategoryId=#{materialCategoryItem.dataDictionaryItemId}
                </if>
            </if>
            <if test="1==1">
                and materialCategoryId is not null
            </if>
        </where>
    </select>

    <select id="getCountByCode" parameterType="String" resultType="int">
        select count(*) from t_pl_ingredients_list_tree
        where code=#{code};
    </select>

    <select id="getCountByType" parameterType="String" resultType="int">
        select count(*) from t_pl_ingredients_list_tree
        where left(code,2)=#{type};
    </select>

    <!--新增辅料备件物品-->
    <insert id="addIngredient" parameterType="Ingredients">
        insert into t_pl_ingredients_list_tree
        (id,name,code,specification,creationTime,materialCategoryId,unitId)
        values
        (#{code},#{name},#{code},#{specification},NOW(),#{materialCategoryItem.dataDictionaryItemId},#{unitDataItem.dataDictionaryItemId});
    </insert>

    <update id="updateIngredient" parameterType="Ingredients">
        update t_pl_ingredients_list_tree
        set name=#{name},code=#{code},specification=#{specification},materialCategoryId=#{materialCategoryItem.dataDictionaryItemId},unitId=#{unitDataItem.dataDictionaryItemId}
        where id=#{id};
    </update>

    <update id="updateCodeByIngredient" parameterType="Ingredients">
        update t_pl_ingredients_list_tree
        set code=#{code},id=#{code},unitId=#{unitDataItem.dataDictionaryItemId}
        where name=#{name} and specification=#{specification} and materialCategoryId=#{materialCategoryItem.dataDictionaryItemId};
    </update>

    <delete id="deleteIngredient" parameterType="int">
        delete from t_pl_ingredients_list_tree where id=#{id};
    </delete>

    <!--辅料物品树状结构-->
    <!--获取辅料备件物品树状结构数据-->
    <select id="listIngredientsTree" resultMap="IngredientsTreeRM">
        select * from t_pl_ingredients_list_tree;
    </select>

    <select id="getIngredientsTreeById" parameterType="int" resultMap="IngredientsTreeRM">
        select * from t_pl_ingredients_list_tree where id=#{id};
    </select>

    <select id="maxByPId" parameterType="int" resultType="int">
        select max(id) from t_pl_ingredients_list_tree where pId=#{pId};
    </select>

    <select id="countTreeByPId" parameterType="int" resultType="int">
        select count(id) from t_pl_ingredients_list_tree where pId=#{pId};
    </select>

    <!--根据ID获取其子节点-->
    <select id="getChildrenIngredientsTreeById" resultMap="IngredientsTreeRM">
        select * from t_pl_ingredients_list_tree where pId=#{id};
    </select>

    <insert id="addIngredientsTree" parameterType="IngredientsTree">
        insert into t_pl_ingredients_list_tree
        (id,code,pId,name,specification,materialCategoryId,unitId,creationTime,modifyTime)
        values
        (#{id},#{id},#{pId},#{name},#{specification},#{materialCategoryItem.dataDictionaryItemId},
        #{unitDataItem.dataDictionaryItemId},NOW(),NOW());
    </insert>

    <update id="updateIngredientTree" parameterType="IngredientsTree">
        update t_pl_ingredients_list_tree
        set name=#{name},specification=#{specification},materialCategoryId=#{materialCategoryItem.dataDictionaryItemId},
        unitId=#{unitDataItem.dataDictionaryItemId},pId=#{pId},modifyTime=NOW() where id=#{id};
    </update>

    <update id="updatePartIngredientTreeBuId" parameterType="IngredientsTree">
        update t_pl_ingredients_list_tree
        set name=#{name},specification=#{specification},unitId=#{unitDataItem.dataDictionaryItemId},id=#{code},code=#{code}
        modifyTime=NOW() where id=#{id};
    </update>

    <delete id="deleteById" parameterType="int">
        delete from t_pl_ingredients_list_tree where id=#{id};
    </delete>
</mapper>