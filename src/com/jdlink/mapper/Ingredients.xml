<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jdlink.mapper.IngredientsMapper">
    <!-- 入库单-->
    <resultMap id="IngredientsInRM" type="IngredientsIn" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getInItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="InIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="inId" property="id"/>
        <result column="serialNumberIn" property="serialNumber"/>
    </resultMap>

    <select id="getInItems" parameterType="String" resultMap="InIngredientsRM">
        select * from t_pr_ingredients where inId = #{id};
    </select>

    <select id="countInById" resultType="int">
        select count(*) from t_pr_ingredients_in where id like "%"#{id}"%";
    </select>

    <select id="countIn" resultType="int">
        select count(*) from t_pr_ingredients_in;
    </select>

    <select id="listPageIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getInById" parameterType="String" resultMap="IngredientsInRM">
          select * from t_pr_ingredients_in where id = #{id};
     </select>

    <select id="searchIn" parameterType="IngredientsIn" resultMap="IngredientsInRM">
        select * from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchInCount" parameterType="IngredientsIn" resultType="int">
        select count(*) from t_pr_ingredients_in
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or acceptor like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
    </select>

    <select id="getIngredientsInItemByRange" resultMap="InIngredientsRM">
        select * from t_pr_ingredients
        <where>
            inId in (SELECT id FROM t_pr_ingredients_in
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
               and equipment = #{equipment};
            </if>
        </where>

        SELECT * FROM t_pr_ingredients_in
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>
    </select>

    <select id="getAmountItems" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory
        where name = #{name} and wareHouseName = #{wareHouseName};
    </select>

    <update id="invalidIn" parameterType="String">
        update t_pr_ingredients_in set state = 'Invalid' where id = #{id}
    </update>

    <update id="updateIn" parameterType="IngredientsIn">
        update t_pr_ingredients_in
        set
        companyName=#{companyName},fileId=#{fileId},totalPrice=#{totalPrice},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},acceptor=#{acceptor},handlers=#{handlers},nowTime=NOW()
        where id = #{id};

        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},equipment=#{ingredients.equipment}
                where inId = #{ingredients.id} and serialNumberIn = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <insert id="addIn" parameterType="IngredientsIn">
        <if test="procurementIdList != null and procurementIdList.size() > 0">
            <foreach collection="procurementIdList" item="procurementId" index="index">
                update t_pl_procurement
                set
                state = "ToPick"
                where receiptNumber = #{procurementId};
            </foreach>
        </if>
        insert into t_pr_ingredients_in
        (id,companyName,creationDate,fileId,totalPrice,bookkeeper,approver,keeper,
        acceptor,handlers,state,nowTime)
        values
        (#{id},#{companyName},NOW(),#{fileId},#{totalPrice},#{bookkeeper},#{approver},#{keeper},
        #{acceptor},#{handlers},'NewBuild',NOW());
        <if test="ingredientsList != null and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (inId,serialNumberIn,name,unitPrice,totalPrice,amount,wareHouseName,post,specification,unit,ingredientState,remarks,equipment)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.amount},#{ingredients.wareHouseName},
                #{ingredients.post},#{ingredients.specification},#{ingredients.unit},'ToReceive',#{ingredients.remarks},#{ingredients.equipment});
                <choose>
                    <when test="ingredients.aid != 'exist'">
                        insert into t_pr_ingredients_inventory
                        (name,wareHouseName,amount,unit,ingredientState,specification)
                        values
                        (#{ingredients.name},#{ingredients.wareHouseName},#{ingredients.amount},#{ingredients.unit},'ToReceive',#{ingredients.specification});
                    </when>
                    <otherwise>
                        update t_pr_ingredients_inventory
                        set
                        amount = amount + #{ingredients.amount}
                        where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
                    </otherwise>
                </choose>
            </foreach>
        </if>
    </insert>

    <!--领料单-->
    <resultMap id="IngredientsReceiveRM" type="IngredientsReceive" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getReceiveItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="ReceiveIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="receiveId" property="id"/>
        <result column="serialNumberReceive" property="serialNumber"/>
    </resultMap>

    <select id="getReceiveItems" parameterType="String" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients where receiveId = #{id};
    </select>

    <select id="countReceiveById" resultType="int">
        select count(*) from t_pr_ingredients_receive where id like "%"#{id}"%";
    </select>

    <select id="countReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive;
    </select>

    <select id="listPageReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive order by nowTime desc
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getReceiveById" parameterType="String" resultMap="IngredientsReceiveRM">
          select * from t_pr_ingredients_receive where id = #{id};
     </select>
    
    <select id="searchReceive" parameterType="IngredientsReceive" resultMap="IngredientsReceiveRM">
        select * from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchReceiveCount" parameterType="IngredientsReceive" resultType="int">
        select count(*) from t_pr_ingredients_receive
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or department like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or vicePresident like "%"#{keywords}"%"
                or wareHouseSupervisor like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or pickingSupervisor like "%"#{keywords}"%"
                or pickingMan like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="department !=null and department !='' ">
                and department like "%"#{department}"%"
            </if>
        </where>
    </select>

    <select id="getAmountAndReceive" parameterType="Ingredients" resultMap="ReceiveIngredientsRM">
        select * from t_pr_ingredients_inventory where name=#{name} and wareHouseName=#{wareHouseName};
    </select>

    <select id="getInventoryList" resultType="Ingredients">
        select * from t_pr_ingredients_inventory
        <if test="start != null and count != null and count != 0">
            limit #{start}, #{count};
        </if>
    </select>

    <select id="countInventory" resultType="int">
        select count(*) from t_pr_ingredients_inventory where amount != 0;
    </select>

    <select id="getInventoryByNameAndWare" resultType="Ingredients">
        select * from t_pr_ingredients_inventory where name = #{name} and wareHouseName = #{wareHouseName};
    </select>

    <select id="searchInventoryCount" parameterType="Ingredients" resultType="int">
        select count(*) from t_pr_ingredients_inventory
        <where>
            <if test="keywords != null and keywords != ''">
                or itemId = #{keywords}
                or name like "%"#{keywords}"%"
                or wareHouseName like "%"#{keywords}"%"
                or amount = #{keywords}
                or unit like "%"#{keywords}"%"
                or ingredientState like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="name != null and name != ''">
                name like "%"#{name}"%"
            </if>
            <if test="amount != null and amount != ''">
                amount = #{amount}
            </if>
        </where>
    </select>

    <select id="searchInventory" resultType="Ingredients">
        select * from t_pr_ingredients_inventory
        <where>
            <if test="keywords != null and keywords != ''">
                or itemId = #{keywords}
                or name like "%"#{keywords}"%"
                or wareHouseName like "%"#{keywords}"%"
                or amount = #{keywords}
                or unit like "%"#{keywords}"%"
                or ingredientState like "%"#{keywords}"%"
                or specification like "%"#{keywords}"%"
            </if>
            <if test="wareHouseName != null and wareHouseName != ''">
                wareHouseName like "%"#{wareHouseName}"%"
            </if>
            <if test="name != null and name != ''">
                name like "%"#{name}"%"
            </if>
            <if test="amount != null and amount != ''">
                amount = #{amount}
            </if>
        </where>
        <if test="page != null and page.start != null and page.count != null and page.count != 0">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <update id="invalidReceive" parameterType="String">
        update t_pr_ingredients_receive set state = 'Invalid' where id = #{id}
    </update>

    <update id="updateReceive" parameterType="IngredientsReceive">
        update t_pr_ingredients_receive
        set
        department=#{department},fileId=#{fileId},totalAmount=#{totalAmount},vicePresident=#{vicePresident},warehouseSupervisor=#{warehouseSupervisor},
        keeper=#{keeper},pickingSupervisor=#{pickingSupervisor},pickingMan=#{pickingMan},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},amount=0,wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},
                specification=#{ingredients.specification},unit=#{ingredients.unit},remarks=#{ingredients.remarks},receiveAmount=#{ingredients.receiveAmount},
                ingredientState=IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received')
                where receiveId = #{ingredients.id} and serialNumberReceive = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <update id="updateReceiveState" parameterType="String" >
        update t_pr_ingredients_receive
        set
        state = 'OutBounded'
        where id = #{id};
    </update>

    <insert id="addAllReceive" parameterType="IngredientsReceive">
        insert into t_pr_ingredients_receive
        (id, department,creationDate,fileId,totalAmount,vicePresident,warehouseSupervisor,keeper,
        pickingSupervisor,pickingMan,state,nowTime)
        values
        (#{id},#{department},NOW(),#{fileId},#{totalAmount},#{vicePresident},#{warehouseSupervisor},#{keeper},
        #{pickingSupervisor},#{pickingMan},'NewBuild',NOW());
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (receiveId,serialNumberReceive,name,receiveAmount,wareHouseName,
                specification,unit,remarks,ingredientState)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},
                #{ingredients.receiveAmount},#{ingredients.wareHouseName},#{ingredients.specification},
                #{ingredients.unit},#{ingredients.remarks},IF(#{ingredients.notReceiveAmount}>0,'PartReceived','Received'));

                update t_pr_ingredients_inventory
                set
                amount = amount-#{ingredients.receiveAmount},ingredientState=IF((amount-#{ingredients.receiveAmount})>0,'PartReceived','Received')
                where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
            </foreach>
        </if>
    </insert>

    <!-- 出库单-->
    <resultMap id="IngredientsOutRM" type="IngredientsOut" autoMapping="true">
        <id column="id" property="id"/>
        <collection property="ingredientsList" select="getOutItems" column="id"
                    ofType="com.jdlink.domain.Produce.Ingredients"
                    javaType="ArrayList"/>
    </resultMap>

    <resultMap id="OutIngredientsRM" type="Ingredients" autoMapping="true">
        <id column="itemId" property="itemId"/>
        <result column="outId" property="id"/>
        <result column="serialNumberOut" property="serialNumber"/>
    </resultMap>

    <select id="getOutItems" parameterType="String" resultMap="OutIngredientsRM">
        select * from t_pr_ingredients where outId = #{id};
    </select>

    <select id="countOutById" resultType="int">
        select count(*) from t_pr_ingredients_out where id like "%"#{id}"%";
    </select>

    <select id="countOut" resultType="int">
        select count(*) from t_pr_ingredients_out;
    </select>

    <select id="listPageOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <select id="getIngredientsOutItemByRange" resultMap="OutIngredientsRM">
        SELECT * FROM t_pr_ingredients
        <where>
            outId in (SELECT id FROM t_pr_ingredients_out
            <![CDATA[WHERE DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d')]]>)
            <if test="equipment != null and equipment != ''">
                AND equipment = #{equipment};
            </if>
        </where>
    </select>

    <select id="getOutById" parameterType="String" resultMap="IngredientsOutRM">
          select * from t_pr_ingredients_out where id = #{id};
     </select>

    <select id="searchOut" parameterType="IngredientsOut" resultMap="IngredientsOutRM">
        select * from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
        order by nowTime desc
        <if test="page != null and page.start != null and page.count != null">
            limit #{page.start}, #{page.count};
        </if>
    </select>

    <select id="searchOutCount" parameterType="IngredientsOut" resultType="int">
        select count(*) from t_pr_ingredients_out
        <where>
            <if test="keywords != null and keywords != ''">
                or id like "%"#{keywords}"%"
                or state like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%m-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y-%c-%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%m%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y%c%e') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%m.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%d') like "%"#{keywords}"%"
                or DATE_FORMAT(creationDate,'%Y.%c.%e') like "%"#{keywords}"%"
                or companyName like "%"#{keywords}"%"
                or fileId like "%"#{keywords}"%"
                or totalAmount = #{keywords}
                or totalPrice = #{keywords}
                or bookkeeper like "%"#{keywords}"%"
                or approver like "%"#{keywords}"%"
                or keeper like "%"#{keywords}"%"
                or handlers like "%"#{keywords}"%"
            </if>
            <if test="id != '' and id != null">
                and id like "%"#{id}"%"
            </if>
            <if test="state != null and state !=''">
                and state like "%"#{state}"%"
            </if>
            <if test="startDate !=null and startDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') >=  DATE_FORMAT(#{startDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="endDate !=null and endDate !=''">
                <![CDATA[ and DATE_FORMAT(creationDate, '%Y-%m-%d') <=  DATE_FORMAT(#{endDate}, '%Y-%m-%d') ]]>
            </if>
            <if test="companyName !=null and companyName !='' ">
                and companyName like "%"#{companyName}"%"
            </if>
        </where>
    </select>

    <update id="invalidOut" parameterType="String">
        update t_pr_ingredients_out set state = 'Invalid' where id = #{id}
    </update>

    <update id="updateOut" parameterType="IngredientsOut">
        update t_pr_ingredients_out
        set
        companyName=#{companyName},fileId=#{fileId},totalPrice=#{totalPrice},totalAmount=#{totalAmount},bookkeeper=#{bookkeeper},approver=#{approver},
        keeper=#{keeper},handlers=#{handlers},nowTime=NOW()
        where id = #{id};
        <if test="ingredientsList != null and ingredientsList != '' and ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                update t_pr_ingredients
                set
                name=#{ingredients.name},unitPrice=#{ingredients.unitPrice},totalPrice=#{ingredients.totalPrice},
                amount=#{ingredients.amount},wareHouseName=#{ingredients.wareHouseName},post=#{ingredients.post},specification=#{ingredients.specification},
                unit=#{ingredients.unit},remarks=#{ingredients.remarks},ingredientState=IF(#{ingredients.notReceiveAmount}=1,'PartOutBound','OutBounded'),
                equipment=#{ingredients.equipment}
                where outId = #{ingredients.id} and serialNumberOut = #{ingredients.serialNumber};
            </foreach>
        </if>
    </update>

    <insert id="addOut" parameterType="IngredientsOut">
        insert into t_pr_ingredients_out
        (id, companyName,creationDate,fileId,totalPrice,totalAmount,bookkeeper,approver,keeper,
        handlers,state,nowTime)
        values
        (#{id},#{companyName},NOW(),#{fileId},#{totalPrice},#{totalAmount},#{bookkeeper},#{approver},#{keeper},
        #{handlers},'NewBuild',NOW());
        <if test="ingredientsList.size() > 0">
            <foreach collection="ingredientsList" item="ingredients" index="index">
                insert into t_pr_ingredients
                (outId,serialNumberOut,name,unitPrice,totalPrice,
                receiveAmount,wareHouseName,post,specification,unit,ingredientState,remarks,equipment)
                values
                (#{ingredients.id},#{ingredients.serialNumber},#{ingredients.name},#{ingredients.unitPrice},
                #{ingredients.totalPrice},#{ingredients.receiveAmount},#{ingredients.wareHouseName},
                #{ingredients.post},#{ingredients.specification},#{ingredients.unit},IF(#{ingredients.notReceiveAmount}>0,'PartOutBound','OutBounded'),#{ingredients.remarks},#{ingredients.equipment});

                <if test="receiveIdList == null or receiveIdList.size() == 0">
                    update t_pr_ingredients_inventory
                    set
                    amount = amount-#{ingredients.receiveAmount},ingredientState=IF((amount-#{ingredients.receiveAmount})>0,'PartReceived','Received')
                    where name=#{ingredients.name} and wareHouseName=#{ingredients.wareHouseName};
                </if>
            </foreach>
        </if>
        <if test="receiveIdList != null and receiveIdList.size() > 0 ">
            <foreach collection="receiveIdList" item="receiveId" index="index">
                update t_pr_ingredients_receive
                set
                state = 'OutBounded'
                where id = #{receiveId};
            </foreach>
        </if>
    </insert>

</mapper>