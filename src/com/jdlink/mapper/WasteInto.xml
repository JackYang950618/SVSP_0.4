<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.WasteIntoMapper">
    <resultMap id="WasteIntoRM" type="WasteInto">
        <collection property="client" column="clientId" select="getClient"></collection>
        <collection property="laboratoryTest" column="{clientId=clientId,wastesCode=wastesCode}" select="getLaboratoryTest"></collection>
    </resultMap>
    <select id="getClient" resultType="Client">
        select  * from client where clientId=#{clientId};
    </select>
    <select id="getLaboratoryTest" resultType="LaboratoryTest">
        select * from t_pr_laboratorytest where clientId=#{clientId} and wastesCode=#{wastesCode};
    </select>
    <select id="WasteIntoList" resultMap="WasteIntoRM">
        select * from t_pl_wasteinto
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>
    <select id="SecondIntoList"  resultMap="WasteIntoRM">
         select * from t_pl_secondaryinto
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>
    <update id="updateWasteInto">
        update t_pl_wasteinto set wastesCategory=(select wastesCategory from t_pl_inboundplanorder where t_pl_wasteinto.transferDraftId=t_pl_inboundplanorder.transferDraftId);
    </update>
    <select id="countWaste" resultType="int">
        select count(*) from t_pl_wasteinto;
    </select>
    <select id="countSec" resultType="int">
        select count(*) from t_pr_secondarysample;
    </select>
    <select id="countById" resultType="int" parameterType="String">
    select count(*) from t_pr_secondarysample where id like "%"#{id}"%";
</select>
    <select id="wastesCountById" resultType="int" parameterType="String">
        select count(*) from t_pr_secondarysampleitem where id like "%"#{id}"%";
    </select>
    <resultMap id="SecondarysampleRM" type="Secondarysample">
        <result property="id" column="id"></result>
        <collection property="client" column="clientId" select="getClient"></collection>
        <collection property="secondarySampleItemList" column="id" select="getSecondarysampleItem"></collection>
    </resultMap>
    <select id="getSecondarysampleItem" resultType="SecondarySampleItem">
        select  * from t_pr_secondarysampleitem where sampleinformationId=#{id};
    </select>
<!--根据编号获取对象-->
    <select id="getSecondarysampleById" parameterType="String" resultMap="SecondarysampleRM">
        select * from t_pr_secondarysample where id=#{id};
    </select>
    <select id="getByWastesId" parameterType="String" resultType="SecondarysampleItem">
        select * from t_pr_secondarysampleitem where id=#{id};
    </select>
    <!--添加次生废物送样主表-->
    <insert id="addSecondarySample" parameterType="SecondarySample">
        insert into t_pr_secondarysample(id, clientId, laboratorySignatory, sendingPerson, address, checkState, advice,nowTime) values
        (#{id},#{client.clientId},#{laboratorySignatory},#{sendingPerson},#{address},'ToCollected',#{advice},NOW());
    </insert>
    <!--添加次生废物送样子表-->
    <insert id="addSecondarySampleItem" parameterType="SecondarySampleItem">
        insert into t_pr_secondarysampleitem (id,wastesCode, wastesName, sampleinformationId, water, scorchingRate) values
        (#{id},#{wastesCode},#{wastesName},#{sampleinformationId},#{water},#{scorchingRate});
    </insert>
    <!--寻找最新的危废送样登记编号-->
    <select id="getNewestId"  resultType="String">
        select id from t_pr_secondarysample order  by  nowTime desc;
    </select>

    <!--查询次生废物送样-->
    <select id="getSecondarysample" resultMap="SecondarysampleRM">
        select * from t_pr_secondarysample order by nowTime desc
        <if test="start != null and count != null">
            limit #{start}, #{count}
        </if>
    </select>

    <!--确认登记-->
    <update id="confirmSecondarySampleById" parameterType="String">
        update t_pr_secondarysample set  checkState='Collected',nowTime=NOW() where id=#{id};
    </update>
    <!--拒收-->
    <update id="rejectSecondarySampleById" >
        update t_pr_secondarysample set checkState='Rejected',advice=#{1} ,nowTime=NOW() where id=#{id}
    </update>
</mapper>