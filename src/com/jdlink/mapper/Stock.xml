<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jdlink.mapper.StockMapper" >
    <resultMap id="StockRM" type="Stock">
        <result property="stockId" column="stockId" javaType="String"></result>
        <result property="proContactName" column="proContactName" javaType="String"></result>
        <result property="proTelepgone" column="proTelepgone" javaType="String"></result>
        <result property="transport" column="transport" javaType="String"></result>
        <result property="transportTelephone" column="transportTelephone" javaType="String"></result>
        <result property="plateNumber" column="plateNumber" javaType="String"></result>
        <result property="checkState" column="checkState" javaType="CheckState"></result>
        <collection property="wastesList" select="getWastes" column="stockId" ofType="com.jdlink.domain.Wastes" javaType="ArrayList"/>
    </resultMap>
<insert id="add" parameterType="Stock">
insert into t_pr_stock(stockId,proContactName,proTelephone,transport,transportTelephone,plateNumber,selfEmployed,nowTime,checkState)
values (#{stockId},#{proContactName},#{proTelephone},#{transport},#{transportTelephone},#{plateNumber},#{selfEmployed},NOW(),#{checkState});
        <foreach collection="wastesList"  item="wastes" index="index">
       insert into t_wastes(id,name,code,wasteAmount,component,remarks,stockId) values (#{wastes.id},#{wastes.name},#{wastes.code},#{wastes.wasteAmount},#{wastes.component},#{wastes.remarks},#{stockId});
        </foreach>
</insert>
    <select id="getStockIdList" resultType="String">
        select  stockId from  t_pr_stock;
    </select>
<select id="list" resultMap="StockRM">
    select * from t_pr_stock order by nowTime desc ;
    <if test="start != null and count != null">
        limit #{start}, #{count}
    </if>
</select>
    <select id="getWastes" resultType="Wastes">
        SELECT * FROM t_wastes WHERE stockId in (
          SELECT t_pr_stock.stockId FROM t_pr_stock
          WHERE t_wastes.stockId=#{stockId});
    </select>
    <update id="updateWastes" parameterType="Wastes">
         update t_wastes set name=#{wastes.name},code=#{wastes.code},
            wasteAmount=#{wastes.wasteAmount},component=#{wastes.component},
            remarks=#{wastes.remarks} where stockId=#{stockId}
    </update>

    <select id="getById" parameterType="String" resultMap="StockRM">
        select * from  t_pr_stock where stockId=#{stockId}
    </select>
    <update id="updateStock" parameterType="Stock" >
        update t_pr_stock set proContactName=#{proContactName},proTelephone=#{proTelephone},
        transport=#{transport},transportTelephone=#{transportTelephone},
        plateNumber=#{plateNumber},selfEmployed=#{selfEmployed},
        nowTime=NOW(),checkState=#{checkState} where stockId=#{stockId};
        <if test="wastesList.size()> 0" >
        <foreach collection="wastesList"  item="wastes" index="index">
            update t_wastes set name=#{wastes.name},code=#{wastes.code},component=#{wastes.component}, wasteAmount=#{wastes.wasteAmount},remarks=#{wastes.remarks} where stockId=#{wastes.stockId};
        </foreach>
        </if>
    </update>
 </mapper>